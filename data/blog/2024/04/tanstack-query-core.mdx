---
title: TanStack QueryëŠ” ì–´ë–»ê²Œ ìƒíƒœ ë³€í™”ë¥¼ ì „íŒŒí• ê¹Œ
date: '2024-04-17'
lastmod: '2024-04-17'
tags: ['tanstack query', 'react-query']
draft: false
summary: 'TanStack Queryê°€ ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì˜ ë³€ê²½ëœ ê°’ìœ¼ë¡œ ë¦¬ë Œë”ë§í•˜ëŠ” ê³¼ì •ì„ ì–´ë–»ê²Œ ìë™ìœ¼ë¡œ í•´ì£¼ëŠ” ê²ƒì¸ì§€ ëŒ€í•œ ê¶ê¸ˆì ì„ í•´ì†Œí•˜ê³ ì ë‚´ë¶€ ë™ì‘ ì›ë¦¬ë¥¼ ì‚´í´ë´¤ìŠµë‹ˆë‹¤.'
series: ë™ì‘ ì›ë¦¬ ì‚´í´ë³´ê¸°
---

## ì„œë¡ 

[ì´ì „](/blog/2023/12/state-management-and-observer)ì— `TanStack Query` ê°€ ê´€ë¦¬í•˜ëŠ” ìƒíƒœì˜ ë³€í™”ë¥¼ ë¦¬ì•¡íŠ¸ ì»´í¬ë„ŒíŠ¸ê°€ ì–´ë–»ê²Œ ê°ì§€í•˜ê³  ë¦¬ë Œë”ë§í•˜ëŠ”ì§€ë¥¼ ì•Œì•„ë³´ë©´ì„œ `useSyncExternalStore` í›…ìœ¼ë¡œ ì™¸ë¶€ì˜ ìƒíƒœë¥¼ êµ¬ë…í•˜ê³  ìˆë‹¤ëŠ” ì ì„ ì‚´í´ë³¸ ì ì´ ìˆì—ˆìŠµë‹ˆë‹¤.

ìµœê·¼ì— `TanStack Query` ê°€ ìºì‹±ì„ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ê³  ìˆëŠ”ì§€ì— ëŒ€í•œ ì§ˆë¬¸ì„ ë°›ì•˜ëŠ”ë°, í‰ì†Œì— ì¢‹ì•„í•˜ê³  ìì£¼ í™œìš©í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ì§€ë§Œ ë‚´ë¶€ ë™ì‘ê¹Œì§€ ê¹Šê²Œ ì‚´í´ë³´ì§„ ëª»í–ˆë˜ ê²ƒ ê°™ì•„ì„œ ì´ë²ˆì— `@tanstack/query-core` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚´í´ë³´ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” TanStack Queryì—ì„œ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì½”ì–´ ìš”ì†Œë“¤ì˜ ê´€ê³„ì— ëŒ€í•´ ì•Œì•„ë³´ê³ , ë‚´ë¶€ì ìœ¼ë¡œ ìºì‹±ì„ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ê³  ìˆëŠ”ì§€ì— ëŒ€í•´ì„œ ì‘ì„±í•´ë³´ê³ ì í•©ë‹ˆë‹¤.  
(`@tanstack/react-query` 5.29.2 ë²„ì „ì„ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.)

## Coreì™€ Adapter

![TanStack Query ì•„í‚¤í…ì²˜ (ì¶œì²˜: TKDodo's Blog)](/static/images/2024/04/tanstack-query-core/react-query-architecture.png)

```
ğŸ“ packages
  ğŸ“ query-core: í•µì‹¬ ë¡œì§ì´ ë“¤ì–´ìˆëŠ” íŒ¨í‚¤ì§€
  ğŸ“ react-query: Reactìš© ì–´ëŒ‘í„°
  ğŸ“ solid-query: Solidìš© ì–´ëŒ‘í„°
  ğŸ“ svelte-query: Svelteìš© ì–´ëŒ‘í„°
  ğŸ“ vue-query: Vueìš© ì–´ëŒ‘í„°
```

`TanStack Query` íŒ¨í‚¤ì§€ëŠ” `query-core` ë¼ëŠ” íŒ¨í‚¤ì§€ë¥¼ ë§Œë“¤ì–´ì„œ í•µì‹¬ ë¡œì§ì„ ë¶„ë¦¬í•˜ê³ , ê°ê°ì˜ í”„ë ˆì„ì›Œí¬ì— ë§ê²Œ ì–´ëŒ‘í„° ì—­í• ì„ í•˜ëŠ” íŒ¨í‚¤ì§€ê°€ `react-query`, `solid-query`, `svelte-query`, `vue-query` ë“±ìœ¼ë¡œ ë‚˜ë‰˜ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.

í•µì‹¬ ë¡œì§ì€ ëª¨ë‘ `query-core` ì— ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì— ìƒˆë¡œìš´ í”„ë ˆì„ì›Œí¬ë¥¼ ìœ„í•œ ì–´ëŒ‘í„°ë¥¼ ë§Œë“¤ê¸°ë„ ìˆ˜ì›”í•œë°ìš”. ì‹¤ì œë¡œ Reactìš© `useQuery` ì–´ëŒ‘í„°ì—ëŠ” ì•½ 100ì¤„ ê°€ëŸ‰ì˜ ì½”ë“œë§Œ ì¡´ì¬í•œë‹¤ëŠ” ê²ƒì„ ë©”ì¸í…Œì´ë„ˆ TKdodoë‹˜ì€ ì´ì•¼ê¸°í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ `TanStack Query` ì˜ ë¡œì§ì„ ì‚´í´ë³´ê¸° ìœ„í•´ì„ , `query-core` íŒ¨í‚¤ì§€ë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

## TanStack Queryì˜ ì¶”ìƒ í´ë˜ìŠ¤

`@tanstack/query-core` ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œëŠ” ì—¬ëŸ¬ í•µì‹¬ ìš”ì†Œê°€ í´ë˜ìŠ¤ë¡œ ì‘ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.  
ê°ê°ì˜ ìš”ì†Œë¥¼ ì•Œì•„ë³´ê¸°ì— ì•ì„œ, ìì£¼ ìƒì†ë˜ì–´ ì‚¬ìš©ë˜ëŠ” ë‘ ì¶”ìƒ í´ë˜ìŠ¤ `Subscribable`, `Removable` ì— ëŒ€í•´ì„œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

### Subscribable

![Subscribable](/static/images/2024/04/tanstack-query-core/subscribable.png)

êµ¬ë… ê°€ëŠ¥í•œ ëŒ€ìƒì„ì„ ë‚˜íƒ€ë‚´ëŠ” ì¶”ìƒ í´ë˜ìŠ¤ì…ë‹ˆë‹¤.  
ì´ í´ë˜ìŠ¤ë¥¼ ìƒì†í•˜ë©´ ìì‹ ì„ êµ¬ë…í•˜ëŠ” êµ¬ë…ìë¥¼ ê°€ì§ˆ ìˆ˜ ìˆê²Œ ë˜ê³ , ìì‹ ì˜ ìƒíƒœê°€ ë³€í™”í•˜ë©´ êµ¬ë…ìë“¤ì—ê²Œ ë³€í™”ë¥¼ ì•Œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. `QueryObserver` ì™€ `QueryCache` ê°€ ì´ ì¶”ìƒ í´ë˜ìŠ¤ë¥¼ ìƒì†í•˜ê³  ìˆìŠµë‹ˆë‹¤.

- `subscribe`: í•´ë‹¹ í•¨ìˆ˜ì˜ ì¸ìë¡œ êµ¬ë…ìë¥¼ ì „ë‹¬ë°›ìœ¼ë©´, `listeners` ì— ë“±ë¡ë˜ê²Œ ë©ë‹ˆë‹¤. ë¦¬ì•¡íŠ¸ì—ì„œëŠ” `useBaseQuery` í›…ì—ì„œ ì´ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ë…í•˜ê³  ìˆìŠµë‹ˆë‹¤.
- `onSubscribe`: ì´ í´ë˜ìŠ¤ë¥¼ ìƒì†í•œ ê³³ì—ì„œ ì´ ë©”ì†Œë“œë¥¼ ì˜¤ë²„ë¼ì´ë”©í•˜ë©´, êµ¬ë… ì •ë³´ê°€ ë³€ê²½ë  ë•Œ ìˆ˜í–‰í•´ì•¼ í•  ë™ì‘ì„ ì£¼ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> subscribe í•¨ìˆ˜ê°€ êµ¬ë…ì„ ì •ë¦¬í•˜ëŠ” í•¨ìˆ˜ë¥¼ ë°˜í™˜í•˜ëŠ” ì´ìœ ëŠ” Reactì˜ `useSyncExternalStore` í˜¹ì€ `useEffect` í›…ì„ ì‚¬ìš©í•˜ì—¬ êµ¬ë…í•  ë•Œ í´ë¦°ì—… í•¨ìˆ˜ì— êµ¬ë…ì„ ì •ë¦¬í•˜ëŠ” ë‚´ìš©ì„ ì‘ì„±í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

```ts {2, 10-17, 24} showLineNumbers
export class Subscribable<TListener extends Function = Listener> {
  protected listeners: Set<TListener>

  constructor() {
    this.listeners = new Set()
    this.subscribe = this.subscribe.bind(this)
  }

  subscribe(listener: TListener): () => void {
    this.listeners.add(listener)

    this.onSubscribe()

    return () => {
      this.listeners.delete(listener)
      this.onUnsubscribe()
    }
  }

  hasListeners(): boolean {
    return this.listeners.size > 0
  }

  protected onSubscribe(): void {
    // Do nothing
  }

  protected onUnsubscribe(): void {
    // Do nothing
  }
}
```

### Removable

ì œê±° ê°€ëŠ¥í•œ ëŒ€ìƒì„ì„ ë‚˜íƒ€ë‚´ëŠ” ì¶”ìƒ í´ë˜ìŠ¤ì…ë‹ˆë‹¤.  
`gcTime` ë§Œí¼ì˜ ì‹œê°„ë™ì•ˆ ëŒ€ê¸°í–ˆë‹¤ê°€, ìƒì†í•œ í´ë˜ìŠ¤ê°€ êµ¬í˜„í•œ `optionalRemove` ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•˜ëŠ” íƒ€ì´ë¨¸ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

```ts {3, 13-15, 31} showLineNumbers
export abstract class Removable {
  gcTime!: number
  #gcTimeout?: ReturnType<typeof setTimeout>

  destroy(): void {
    this.clearGcTimeout()
  }

  protected scheduleGc(): void {
    this.clearGcTimeout()

    if (isValidTimeout(this.gcTime)) {
      this.#gcTimeout = setTimeout(() => {
        this.optionalRemove()
      }, this.gcTime)
    }
  }

  protected updateGcTime(newGcTime: number | undefined): void {
    // Default to 5 minutes (Infinity for server-side) if no gcTime is set
    this.gcTime = Math.max(this.gcTime || 0, newGcTime ?? (isServer ? Infinity : 5 * 60 * 1000))
  }

  protected clearGcTimeout() {
    if (this.#gcTimeout) {
      clearTimeout(this.#gcTimeout)
      this.#gcTimeout = undefined
    }
  }

  protected abstract optionalRemove(): void
}
```

ì´ ì¶”ìƒ í´ë˜ìŠ¤ëŠ” `Query` í´ë˜ìŠ¤ê°€ ìƒì†í•´ì„œ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë©°, ì¼ì • ì‹œê°„ì´ ì§€ë‚˜ë©´ ìºì‹œì—ì„œ ë°ì´í„°ë¥¼ ì™„ì „íˆ ì œê±°í•˜ê¸° ìœ„í•´ ì¡´ì¬í•©ë‹ˆë‹¤.

```ts {6} showLineNumbers
export class Query extends Removable {
  #cache: QueryCache

  protected optionalRemove() {
    if (!this.#observers.length && this.state.fetchStatus === 'idle') {
      this.#cache.remove(this)
    }
  }
}
```

import { useSyncExternalStore } from 'react'

## TanStack Queryì˜ í•µì‹¬ ìš”ì†Œ

![TanStack Queryì˜ í•µì‹¬ ìš”ì†Œ](/static/images/2024/04/tanstack-query-core/classes.png)

ì´ì œ ì½”ì–´ íŒ¨í‚¤ì§€ì— ì¡´ì¬í•˜ëŠ” í•µì‹¬ ìš”ì†Œë¥¼ ì•Œì•„ë³´ê¸° ìœ„í•´ `@tanstack/query-core` ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì¡´ì¬í•˜ëŠ” ìš”ì†Œë“¤ì˜ ì˜ì¡´ ê´€ê³„ ë° ì¹´ë””ë„ë¦¬í‹°ë¥¼ í‘œí˜„í•´ë³´ì•˜ìŠµë‹ˆë‹¤.  
ê°ê°ì˜ í´ë˜ìŠ¤ê°€ ì°¸ì—¬í•˜ê³  ìˆëŠ” ê´€ê³„ë¥¼ `1:1`, `1:N` ìœ¼ë¡œ ë‚˜íƒ€ëƒˆê³ , ì˜ì¡´í•˜ê³  ìˆëŠ” ë°©í–¥ì„ í™”ì‚´í‘œë¡œ í‘œí˜„í–ˆìŠµë‹ˆë‹¤.

ê°ê°ì˜ ì—­í• ì„ ê°„ë‹¨í•˜ê²Œ ì •ë¦¬í•´ë³´ìë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- **useBaseQuery**: ì½”ì–´ê°€ ì•„ë‹Œ `@tanstack/react-query` íŒ¨í‚¤ì§€ì— ì¡´ì¬í•˜ëŠ” í›…ì…ë‹ˆë‹¤. TanStack Queryì˜ í•µì‹¬ ë¡œì§ì€ ëŒ€ë¶€ë¶„ ì½”ì–´ íŒ¨í‚¤ì§€ì— ì¡´ì¬í•˜ëŠ”ë°, `useBaseQuery` ëŠ” ë‹¨ìˆœíˆ ì½”ì–´ íŒ¨í‚¤ì§€ë¥¼ ë¦¬ì•¡íŠ¸ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì–´ëŒ‘í„° ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. `useQuery`, `useSuspenseQuery`, `useInfiniteQuery`, `useSuspenseInfiniteQuery` ë“± ëª¨ë“  í›…ì€ ë‚´ë¶€ì ìœ¼ë¡œ `useBaseQuery` í›…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- **QueryObserver**: Queryì˜ ìƒíƒœì— ë³€í™”ê°€ ë°œìƒí•˜ë©´ ìƒˆë¡œìš´ ê²°ê³¼ê°’ì„ ë§Œë“  ë’¤ êµ¬ë…ìë“¤ì—ê²Œ ì•Œë ¤ì„œ ë¦¬ë Œë”ë§ì„ ë°œìƒì‹œí‚µë‹ˆë‹¤. ë¦¬ì•¡íŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ `useQuery` í›…ì„ ì„ ì–¸í•˜ëŠ” ìœ„ì¹˜ë§ˆë‹¤ `QueryObserver` ê°€ í•˜ë‚˜ì”© ìƒì„±ë˜ë©°, ë¦¬ì•¡íŠ¸ ì»´í¬ë„ŒíŠ¸ê°€ `QueryObserver` ì˜ êµ¬ë…ìê°€ ë©ë‹ˆë‹¤.
- **QueryClient**: ìºì‹±ëœ ë°ì´í„°ì— ì ‘ê·¼í•˜ê³  ì¡°ì‘í•  ìˆ˜ ìˆëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì´ APIëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©ìì—ê²Œë„ ì œê³µë©ë‹ˆë‹¤.
- **QueryCache**: ê° ì¿¼ë¦¬ í‚¤ ë³„ ê³ ìœ í•œ `Query` ê°ì²´ë¥¼ ê´€ë¦¬í•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ë•ë¶„ì— ì¤‘ë³µëœ ì¿¼ë¦¬ í‚¤ë¥¼ ê°€ì§„ ê°ì²´ëŠ” í•˜ë‚˜ë§Œ ìƒì„±í•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **Query**: ê° ì¿¼ë¦¬ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„° ë° ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì£¼ì…í•œ `queryFn` ì´ ìµœì¢…ì ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ ë°œìƒí•˜ëŠ” ê²ƒë„ ì´ í´ë˜ìŠ¤ê°€ ë‹´ë‹¹í•©ë‹ˆë‹¤.

í•œ ë¬¸ë‹¨ìœ¼ë¡œ í‘œí˜„í•˜ìë‹ˆ ì´í•´í•˜ê¸°ê°€ ì‰½ì§€ ì•Šì€ë°, ì½”ë“œë¥¼ ì‚´í´ë³´ë©´ì„œ ê°ê°ì˜ ì—­í• ì„ íŒŒì•…í•œ ë‚´ìš©ì„ ì„œìˆ í•˜ê² ìŠµë‹ˆë‹¤.

### QueryClient

![QueryClient](/static/images/2024/04/tanstack-query-core/query-client.png)

TanStack Queryê°€ ìºì‹±í•˜ê³  ìˆëŠ” QueryCacheì™€ MutationCacheë¥¼ ì¡°ì‘í•˜ëŠ” ì—¬ëŸ¬ ë©”ì†Œë“œë¥¼ ì œê³µí•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ í´ë˜ìŠ¤ì…ë‹ˆë‹¤. `queryCache` ê³¼ `mutationCache` ë¥¼ ë‚´ë¶€ì˜ í”„ë¡œí¼í‹°ë¡œ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì— ìºì‹±ëœ ë°ì´í„°ì— ì ‘ê·¼í•˜ê³  ì¡°ì‘í•˜ëŠ” APIë¥¼ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë§ì´ ìƒëµí–ˆì§€ë§Œ [QueryClientì—ì„œ ì œê³µí•˜ëŠ” API](https://tanstack.com/query/latest/docs/reference/QueryClient) ê°€ ëª¨ë‘ ë©”ì†Œë“œë¡œ êµ¬í˜„ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

> 24ì¤„ì„ ì‚´í´ë³´ë©´, ìºì‹œì— ì €ì¥í•  ë°ì´í„°ë¥¼ ë°”ë¡œ ì €ì¥í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì½œë°±ì„ ëª¨ì•„ì„œ í•œë²ˆì— ì²˜ë¦¬í•˜ëŠ” ë°°ì¹­ì´ ì ìš©ë˜ì–´ìˆë‹¤ëŠ” ì ì„ í™•ì¸í•  ìˆ˜ ìˆëŠ”ë°ìš”. ì´ ë¶€ë¶„ì€ `notifyManager` ì— ëŒ€í•´ì„œ ì‚´í´ë³¼ ë•Œ í›„ìˆ í•˜ê² ìŠµë‹ˆë‹¤.

```ts {2-3, 6-7, 24} showLineNumbers
export class QueryClient {
  #queryCache: QueryCache
  #mutationCache: MutationCache

  constructor(config: QueryClientConfig = {}) {
    this.#queryCache = config.queryCache || new QueryCache()
    this.#mutationCache = config.mutationCache || new MutationCache()
  }

  getQueriesData<TQueryFnData = unknown>(
    filters: QueryFilters
  ): Array<[QueryKey, TQueryFnData | undefined]> {
    return this.#queryCache.findAll(filters).map(({ queryKey, state }) => {
      const data = state.data as TQueryFnData | undefined
      return [queryKey, data]
    })
  }

  setQueriesData<TQueryFnData>(
    filters: QueryFilters,
    updater: Updater<TQueryFnData | undefined, TQueryFnData | undefined>,
    options?: SetDataOptions
  ): Array<[QueryKey, TQueryFnData | undefined]> {
    return notifyManager.batch(() =>
      this.#queryCache
        .findAll(filters)
        .map(({ queryKey }) => [
          queryKey,
          this.setQueryData<TQueryFnData>(queryKey, updater, options),
        ])
    )
  }
}
```

ë˜í•œ, ì•„ë˜ ì½”ë“œëŠ” `fetchQuery` ë©”ì†Œë“œì¸ë°ìš”.  
12ì¤„ì—ì„œ `QueryCache` ê°ì²´ì˜ `build` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•´ì„œ `Query` ê°ì²´ë¥¼ ìƒì„±í•œ ë’¤, ë°ì´í„°ë¥¼ íŒ¨ì¹­í•˜ê¸° ìœ„í•´ `fetch` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ê³  ìˆë‹¤ëŠ” ì ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> 14ì¤„ì˜ `isStaleByTime` ë©”ì†Œë“œë¥¼ í†µí•´ `staleTime` ë§Œí¼ì˜ ì‹œê°„ì´ ì§€ë‚¬ëŠ”ì§€ë¥¼ ì²´í¬í•˜ì—¬ ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ì¤„ì˜€ë‹¤ëŠ” ë¶€ë¶„ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts {12, 14-16} showLineNumbers
export class QueryClient {
  fetchQuery(
    options: FetchQueryOptions<TQueryFnData, TError, TData, TQueryKey, TPageParam>
  ): Promise<TData> {
    const defaultedOptions = this.defaultQueryOptions(options)

    // https://github.com/tannerlinsley/react-query/issues/652
    if (defaultedOptions.retry === undefined) {
      defaultedOptions.retry = false
    }

    const query = this.#queryCache.build(this, defaultedOptions)

    return query.isStaleByTime(defaultedOptions.staleTime)
      ? query.fetch(defaultedOptions)
      : Promise.resolve(query.state.data as TData)
  }
}
```

### QueryCache

![QueryCache](/static/images/2024/04/tanstack-query-core/query-cache.png)

`QueryCache` ëŠ” ì—¬ëŸ¬ ì¿¼ë¦¬ ë°ì´í„°ë¥¼ ë³´ê´€í•˜ê³  ìˆëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. ë‚´ë¶€ì— `queries` ë¼ëŠ” Map ê°ì²´ê°€ ì¡´ì¬í•˜ëŠ”ë°, ì´ í”„ë¡œí¼í‹°ëŠ” **ê°™ì€ keyë¥¼ ê°–ëŠ” ì¿¼ë¦¬ëŠ” ë‹¨ì¼ ê°ì²´ë§Œ ì¡´ì¬í•˜ë„ë¡** ê´€ë¦¬í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

> 17ì¤„ì˜ `build` ë©”ì†Œë“œëŠ” `queryKey` ë¥¼ `queryHash` ë¡œ ë³€í™˜í•œ ë’¤, Mapì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¿¼ë¦¬ ê°ì²´ê°€ ìˆë‹¤ë©´ í•´ë‹¹ ê°ì²´ë¥¼ ì¬í™œìš©í•˜ê³ , ì—†ë‹¤ë©´ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```ts {10, 14, 17, 22-24, 27, 35} showLineNumbers
export interface QueryStore {
  has: (queryHash: string) => boolean
  set: (queryHash: string, query: Query) => void
  get: (queryHash: string) => Query | undefined
  delete: (queryHash: string) => void
  values: () => IterableIterator<Query>
}

export class QueryCache extends Subscribable<QueryCacheListener> {
  #queries: QueryStore

  constructor(public config: QueryCacheConfig = {}) {
    super()
    this.#queries = new Map<string, Query>()
  }

  build<TQueryFnData, TError, TData, TQueryKey extends QueryKey>(
    client: QueryClient,
    options: WithRequired<QueryOptions<TQueryFnData, TError, TData, TQueryKey>, 'queryKey'>,
    state?: QueryState<TData, TError>
  ): Query<TQueryFnData, TError, TData, TQueryKey> {
    const queryKey = options.queryKey
    const queryHash = options.queryHash ?? hashQueryKeyByOptions(queryKey, options)
    let query = this.get<TQueryFnData, TError, TData, TQueryKey>(queryHash)

    if (!query) {
      query = new Query({
        cache: this,
        queryKey,
        queryHash,
        options: client.defaultQueryOptions(options),
        state,
        defaultOptions: client.getQueryDefaults(queryKey),
      })
      this.add(query)
    }

    return query
  }

  get<
    TQueryFnData = unknown,
    TError = DefaultError,
    TData = TQueryFnData,
    TQueryKey extends QueryKey = QueryKey,
  >(queryHash: string): Query<TQueryFnData, TError, TData, TQueryKey> | undefined {
    return this.#queries.get(queryHash) as Query<TQueryFnData, TError, TData, TQueryKey> | undefined
  }
}
```

#### hashKey

build ë©”ì†Œë“œ ë‚´ë¶€ì˜ `hashQueryKeyByOptions` í•¨ìˆ˜ê°€ ìˆ˜í–‰í•˜ëŠ” ì—­í• ì„ íŒŒì•…í•˜ê¸° ìœ„í•´ ì½”ë“œë¥¼ íƒ€ê³  ì˜¬ë¼ê°€ë©´, ì•„ë˜ì˜ `hashKey` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  ìˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆëŠ”ë°ìš”.

```ts showLineNumbers
export function hashKey(queryKey: QueryKey | MutationKey): string {
  return JSON.stringify(queryKey, (_, val) =>
    isPlainObject(val)
      ? Object.keys(val)
          .sort()
          .reduce((result, key) => {
            result[key] = val[key]
            return result
          }, {} as any)
      : val
  )
}
```

ë§Œì•½ ì•„ë˜ì™€ ê°™ì´ ì¿¼ë¦¬ í‚¤ í˜•íƒœì— ë§ëŠ” ë°°ì—´ì„ ì‘ì„±í•´ì¤¬ì„ ë•Œ, í•´ì‹±í•œ ë¬¸ìì—´ì„ ë§Œë“¤ì–´ë‚´ê³ , ì´ ë¬¸ìì—´ì„ Mapì˜ keyë¡œ ì‚¬ìš©í•˜ì—¬ ë™ì¼í•œ ì¿¼ë¦¬ì˜ ë°ì´í„°ë¥¼ ì¬í™œìš©í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

```ts
const queries = new Map()

queries.set(hashKey(['a', 'b', { hi: 'ì•ˆë…•', bye: 'ë°”ì´' }]), 'ë­”ê°€ ë°ì´í„°..')
queries.set(hashKey(['a', 'b', { hi: 'ì•ˆë…•', bye: 'ë°”ì´' }]), 'ë­”ê°€ ë°ì´í„°..')
queries.set(hashKey(['a', 'b', { hi: 'ì•ˆë…•', bye: 'ë°”ì´' }]), 'ë­”ê°€ ë°ì´í„°..')
queries.set(hashKey(['a', 'b', { hi: 'ì•ˆë…•', bye: 'ë°”ì´' }]), 'ë­”ê°€ ë°ì´í„°..')

console.log(queries) // Map(1) { '["a","b",{"bye":"ë°”ì´","hi":"ì•ˆë…•"}]' => 'ë­”ê°€ ë°ì´í„°..' }
```

ë˜í•œ build ë©”ì†Œë“œ ë‚´ë¶€ì—ì„œ `add` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ë©´ `notify` ë©”ì†Œë“œê°€ ì‹¤í–‰ë˜ì–´ êµ¬ë…ìë“¤ì—ê²Œ ì¿¼ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŒì„ ì•Œë¦¬ê²Œ ë©ë‹ˆë‹¤.

```ts {6-9, 15-17} showLineNumbers
export class QueryCache extends Subscribable<QueryCacheListener> {
  add(query: Query<any, any, any, any>): void {
    if (!this.#queries.has(query.queryHash)) {
      this.#queries.set(query.queryHash, query)

      this.notify({
        type: 'added',
        query,
      })
    }
  }

  notify(event: QueryCacheNotifyEvent) {
    notifyManager.batch(() => {
      this.listeners.forEach((listener) => {
        listener(event)
      })
    })
  }
}
```

### Query

![Query](/static/images/2024/04/tanstack-query-core/query.png)

ì¿¼ë¦¬ì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” í´ë˜ìŠ¤ì…ë‹ˆë‹¤.
í•µì‹¬ì€ `state` ë¼ëŠ” í”„ë¡œí¼í‹°ì— í•´ë‹¹ ì¿¼ë¦¬ê°€ í‘œí˜„í•´ì•¼ í•  ë°ì´í„°ì™€ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ê³ , `#dispatch` ë¼ëŠ” ë‚´ë¶€ ë©”ì†Œë“œë¥¼ í†µí•´ì„œ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•œ ë’¤, êµ¬ë…ìë“¤ì—ê²Œ ë³€í™”ë¥¼ ì•Œë¦°ë‹¤ëŠ” ì ì…ë‹ˆë‹¤.

- **state**: í•´ë‹¹ ì¿¼ë¦¬ê°€ í‘œí˜„í•´ì•¼ í•  ë°ì´í„°ì™€ ìƒíƒœë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
- **fetch**: ì‚¬ìš©ìê°€ ë“±ë¡í•œ `queryFn` ì„ í˜¸ì¶œí•˜ì—¬, ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ ë°œìƒí•˜ë„ë¡ í•˜ëŠ” ë©”ì†Œë“œì…ë‹ˆë‹¤.
- **#dispatch**: `state` ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , êµ¬ë…ìë“¤ì—ê²Œ ë³€í™”ë¥¼ ì•Œë¦¬ëŠ” ë©”ì†Œë“œì…ë‹ˆë‹¤.

```ts {20, 26, 40, 43-47} showLineNumbers
export interface QueryState<TData = unknown, TError = DefaultError> {
  data: TData | undefined
  dataUpdateCount: number
  dataUpdatedAt: number
  error: TError | null
  errorUpdateCount: number
  errorUpdatedAt: number
  fetchFailureCount: number
  fetchFailureReason: TError | null
  fetchMeta: FetchMeta | null
  isInvalidated: boolean
  status: QueryStatus
  fetchStatus: FetchStatus
}

export class Query extends Removable {
  queryKey: TQueryKey
  queryHash: string
  options!: QueryOptions<TQueryFnData, TError, TData, TQueryKey>
  state: QueryState<TData, TError>

  #cache: QueryCache
  #retryer?: Retryer<TData>
  #observers: Array<QueryObserver<any, any, any, any, any>>

  #dispatch(action: Action<TData, TError>): void {
    const reducer = (state: QueryState<TData, TError>): QueryState<TData, TError> => {
      switch (action.type) {
        case 'fetch':
        // ...
        case 'success':
        // ...
        case 'error':
        // ...
        case 'invalidate':
        // ...
      }
    }

    this.state = reducer(this.state)

    notifyManager.batch(() => {
      this.#observers.forEach((observer) => {
        observer.onQueryUpdate()
      })

      this.#cache.notify({ query: this, type: 'updated', action })
    })
  }
}
```

#### fetch

ë˜í•œ `queryFn` ì„ í˜¸ì¶œí•´ì„œ ì‹¤ì œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” `fetch` ë©”ì†Œë“œê°€ ì¡´ì¬í•˜ëŠ” ê³³ì´ê¸°ë„ í•©ë‹ˆë‹¤.

- **fetchFn**: `queryFn` ì„ í˜¸ì¶œí•˜ëŠ” ì¤‘ì²© í•¨ìˆ˜ì…ë‹ˆë‹¤.
- **retryer**: `fetch` í•¨ìˆ˜ëŠ” fetchFn ì„ ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•Šê³ , `retryer` ê°ì²´ë¥¼ ê±°ì³ì„œ ì²˜ë¦¬í•˜ëŠ”ë°ìš”. ê·¸ ì´ìœ ëŠ” ì—¬ëŸ¬ QueryObserverê°€ ë™ì‹œì— ê°™ì€ ì¿¼ë¦¬ë¥¼ êµ¬ë…í•˜ê³  ìˆì„ ë•Œ, ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ QueryObserverì˜ ê°¯ìˆ˜ë§Œí¼ í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë‹¨ í•œë²ˆë§Œ ìˆ˜í–‰í•˜ë„ë¡ í•˜ê¸° ìœ„í•¨ì´ê¸°ë„ í•˜ê³ , ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ ì‹¤íŒ¨í–ˆì„ ë•Œ ë‹¤ì‹œ ì¬ìš”ì²­ì„ í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.

```ts {15-17, 29-32} showLineNumbers
export class Query extends Removable {
  fetch(
    options?: QueryOptions<TQueryFnData, TError, TData, TQueryKey>,
    fetchOptions?: FetchOptions
  ): Promise<TData> {
    const abortController = new AbortController()

    // Create query function context
    const queryFnContext: OmitKeyof<QueryFunctionContext<TQueryKey>, 'signal'> = {
      queryKey: this.queryKey,
      meta: this.meta,
    }

    // Create fetch function
    const fetchFn = () => {
      return this.options.queryFn(queryFnContext as QueryFunctionContext<TQueryKey>)
    }

    // Trigger behavior hook
    const context: OmitKeyof<FetchContext<TQueryFnData, TError, TData, TQueryKey>, 'signal'> = {
      fetchOptions,
      options: this.options,
      queryKey: this.queryKey,
      state: this.state,
      fetchFn,
    }

    // Try to fetch the data
    this.#retryer = createRetryer({
      fn: context.fetchFn as () => Promise<TData>,
      abort: abortController.abort.bind(abortController),
    })

    return this.#retryer.promise
  }
}
```

ë§ì´ ìƒëµí–ˆì§€ë§Œ, createRetryer í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ë©´ ì•„ë˜ ë‚´ìš©ê³¼ ê°™ìŠµë‹ˆë‹¤.  
ì´ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ë©´, ìœ„ì—ì„œë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ì½”ë“œê°€ ì‹¤í–‰ë˜ë©´ì„œ 59ë²ˆ ë¼ì¸ì—ì„œ `run` í•¨ìˆ˜ê°€ í˜¸ì¶œë©ë‹ˆë‹¤.

- **37-39ë²ˆ ë¼ì¸**: ì´ë¯¸ ë°ì´í„°ë¥¼ ë°›ì•„ì™€ì„œ `resolve` ìƒíƒœì¸ ê²½ìš°ì—ëŠ” ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ì–¼ë¦¬ ë¦¬í„´í•©ë‹ˆë‹¤.
- **45ë²ˆ ë¼ì¸**: `Query` ê°ì²´ì˜ `fetch` ë©”ì†Œë“œì—ì„œ `createRetryer` ë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ, `queryFn` ì„ `options.fn` ìœ¼ë¡œ ì „ë‹¬í–ˆëŠ”ë°, ì´ ê²ƒì„ ì‹¤í–‰í•œë‹¤ëŠ” ê²ƒì€ ì¦‰ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ ë°œìƒí•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.
- **59ë²ˆ ë¼ì¸**: `run` í•¨ìˆ˜ê°€ í˜¸ì¶œë©ë‹ˆë‹¤.

```ts {37-39, 45, 59} showLineNumbers
export function createRetryer<TData = unknown, TError = DefaultError>(
  config: RetryerConfig<TData, TError>
): Retryer<TData> {
  let isRetryCancelled = false
  let failureCount = 0
  let isResolved = false
  let continueFn: ((value?: unknown) => boolean) | undefined
  let promiseResolve: (data: TData) => void
  let promiseReject: (error: TError) => void

  const promise = new Promise<TData>((outerResolve, outerReject) => {
    promiseResolve = outerResolve
    promiseReject = outerReject
  })

  const resolve = (value: any) => {
    if (!isResolved) {
      isResolved = true
      config.onSuccess?.(value)
      continueFn?.()
      promiseResolve(value)
    }
  }

  const reject = (value: any) => {
    if (!isResolved) {
      isResolved = true
      config.onError?.(value)
      continueFn?.()
      promiseReject(value)
    }
  }

  // Create loop function
  const run = () => {
    // Do nothing if already resolved
    if (isResolved) {
      return
    }

    let promiseOrValue: any

    // Execute query
    try {
      promiseOrValue = config.fn()
    } catch (error) {
      promiseOrValue = Promise.reject(error)
    }

    Promise.resolve(promiseOrValue)
      .then(resolve)
      .catch((error) => {
        // ...
      })
  }

  // Start loop
  if (canFetch(config.networkMode)) {
    run()
  } else {
    pause().then(run)
  }

  return {
    promise,
    cancel,
    continue: () => {
      const didContinue = continueFn?.()
      return didContinue ? promise : Promise.resolve()
    },
    cancelRetry,
    continueRetry,
  }
}
```

#### êµ¬ë…ìëŠ” ëˆ„êµ¬?

`Query` ë¥¼ êµ¬ë…í•˜ëŠ” êµ¬ë…ìëŠ” ëˆ„êµ¬ì´ê³ , ë˜ ì–´ë–»ê²Œ êµ¬ë… ê³¼ì •ì´ ë°œìƒí•˜ëŠ” ê²ƒì¸ì§€ ì˜ë¬¸ì´ ë“¤ ìˆ˜ ìˆëŠ”ë°ìš”.  
ì•„ë˜ ì½”ë“œë¥¼ ì‚´í´ë³´ë©´, êµ¬ë…ìëŠ” `QueryObserver` ë¼ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  ì´ `addObserver` ê°€ í˜¸ì¶œë˜ëŠ” ì‹œì ì€ QueryObserverê°€ êµ¬ë…ë˜ëŠ” ì‹œì ì…ë‹ˆë‹¤.

```ts {4} showLineNumbers
export class Query extends Removable {
  #observers: Array<QueryObserver<any, any, any, any, any>>

  addObserver(observer: QueryObserver<any, any, any, any, any>): void {
    if (!this.#observers.includes(observer)) {
      this.#observers.push(observer)

      // Stop the query from being garbage collected
      this.clearGcTimeout()

      this.#cache.notify({ type: 'observerAdded', query: this, observer })
    }
  }
}
```

### QueryObserver

QueryObserverëŠ” ì¿¼ë¦¬ì˜ ìƒíƒœ ë³€í™”ë¥¼ ê°ì§€í•˜ë©´ ìƒˆë¡œìš´ ê²°ê³¼ê°’ì„ ë§Œë“¤ì–´ë‚´ê³  êµ¬ë…ìë“¤ì—ê²Œ ì•Œë¦¬ëŠ” ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

ë¦¬ì•¡íŠ¸ì—ì„œëŠ” `useQuery` í›…ì„ ì‚¬ìš©í•œ ì»´í¬ë„ŒíŠ¸ê°€ `QueryObserver` ì˜ êµ¬ë…ìê°€ ë©ë‹ˆë‹¤.

- **currentQuery**: `QueryObserver` ê°€ êµ¬ë…í•˜ê³  ìˆëŠ” `Query` ê°ì²´ì…ë‹ˆë‹¤.
- **currentResult**: `QueryObserver` ê°€ ë§Œë“¤ì–´ë‚¸ ê²°ê³¼ê°’ì…ë‹ˆë‹¤.

ì¤‘ìš”í•œ ë¶€ë¶„ì€ ë¦¬ì•¡íŠ¸ ì»´í¬ë„ŒíŠ¸ê°€ `useQuery` ë¥¼ ì‚¬ìš©í•´ì„œ `QueryObserver` ê°ì²´ë¥¼ ìƒì„±í•˜ë©´, `onSubscribe` ë©”ì†Œë“œê°€ ë™ì‘í•œë‹¤ëŠ” ì ì…ë‹ˆë‹¤.

- 12ë²ˆ ë¼ì¸: `Query` ê°ì²´ì˜ `addObserver` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•´ì„œ `Query` ë¥¼ êµ¬ë…í•©ë‹ˆë‹¤.
- 14~18ë²ˆ ë¼ì¸: ë§ˆìš´íŠ¸ ì‹œ ë°ì´í„°ë¥¼ íŒ¨ì¹­í•´ì•¼ í•œë‹¤ë©´ `executeFetch` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ê³ , ê·¸ë ‡ì§€ ì•Šë‹¤ë©´ `updateResult` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

```ts {12, 14-18} showLineNumbers
export class QueryObserver extends Subscribable<QueryObserverListener> {
  #client: QueryClient
  #currentQuery: Query<TQueryFnData, TError, TQueryData, TQueryKey> = undefined!
  #currentResult: QueryObserverResult<TData, TError> = undefined!

  #staleTimeoutId?: ReturnType<typeof setTimeout>
  #refetchIntervalId?: ReturnType<typeof setInterval>
  #currentRefetchInterval?: number | false

  protected onSubscribe(): void {
    if (this.listeners.size === 1) {
      this.#currentQuery.addObserver(this)

      if (shouldFetchOnMount(this.#currentQuery, this.options)) {
        this.#executeFetch()
      } else {
        this.updateResult()
      }

      this.#updateTimers()
    }
  }

  protected onUnsubscribe(): void {
    if (!this.hasListeners()) {
      this.destroy()
    }
  }

  destroy(): void {
    this.listeners = new Set()
    this.#clearStaleTimeout()
    this.#clearRefetchInterval()
    this.#currentQuery.removeObserver(this)
  }
}
```

`executeFetch` ë©”ì†Œë“œëŠ” ì•„ë˜ì²˜ëŸ¼ ì‘ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

- **4ë²ˆ ë¼ì¸**: íŒ¨ì¹­ì„ ì‹œë„í•˜ë ¤ëŠ” ì¿¼ë¦¬ê°€ `gcTime` ì´ ì§€ë‚˜ì„œ ì‚­ì œë˜ì—ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì¿¼ë¦¬ ê°ì²´ë¥¼ `build` í•©ë‹ˆë‹¤.
- **7ë²ˆ ë¼ì¸**: ì¿¼ë¦¬ì— ë“±ë¡ëœ `queryFn` ì„ ì‹¤í–‰í•˜ëŠ” `fetch` ìš”ì²­ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.

```ts {4, 7} showLineNumbers
export class QueryObserver extends Subscribable<QueryObserverListener> {
  #executeFetch(fetchOptions?: ObserverFetchOptions): Promise<TQueryData | undefined> {
    // Make sure we reference the latest query as the current one might have been removed
    this.#updateQuery()

    // Fetch
    let promise: Promise<TQueryData | undefined> = this.#currentQuery.fetch(
      this.options as QueryOptions<TQueryFnData, TError, TQueryData, TQueryKey>,
      fetchOptions
    )

    if (!fetchOptions?.throwOnError) {
      promise = promise.catch(noop)
    }

    return promise
  }
}
```

ë˜í•œ `createResult` ë©”ì†Œë“œë¡œ QueryObserverê°€ ë°˜í™˜í•˜ëŠ” ê²°ê³¼ë¥¼ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤.  
ë°˜í™˜ ê°’ì„ ì‚´í´ë³´ë©´ ìš°ë¦¬ê°€ í”í•˜ê²Œ ì‚¬ìš©í•´ì™”ë˜ `useQuery` ì˜ ë°˜í™˜ ê°’ê³¼ ë™ì¼í•˜ë‹¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ë©”ì†Œë“œëŠ” `updateResult` ë¡œ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•  ë•Œë§ˆë‹¤ í˜¸ì¶œë©ë‹ˆë‹¤.

```ts showLineNumbers
export class QueryObserver extends Subscribable<QueryObserverListener> {
  protected createResult(
    query: Query<TQueryFnData, TError, TQueryData, TQueryKey>,
    options: QueryObserverOptions<TQueryFnData, TError, TData, TQueryData, TQueryKey>
  ): QueryObserverResult<TData, TError> {
    const prevQuery = this.#currentQuery
    const prevOptions = this.options
    const prevResult = this.#currentResult as QueryObserverResult<TData, TError> | undefined
    const prevResultState = this.#currentResultState
    const prevResultOptions = this.#currentResultOptions
    const queryChange = query !== prevQuery
    const queryInitialState = queryChange ? query.state : this.#currentQueryInitialState

    const { state } = query
    let newState = { ...state }
    let isPlaceholderData = false
    let data: TData | undefined

    let { error, errorUpdatedAt, status } = newState

    // Select data if needed
    if (options.select && newState.data !== undefined) {
      // Memoize select result
      if (
        prevResult &&
        newState.data === prevResultState?.data &&
        options.select === this.#selectFn
      ) {
        data = this.#selectResult
      } else {
        try {
          this.#selectFn = options.select
          data = options.select(newState.data)
          data = replaceData(prevResult?.data, data, options)
          this.#selectResult = data
          this.#selectError = null
        } catch (selectError) {
          this.#selectError = selectError as TError
        }
      }
    }
    // Use query data
    else {
      data = newState.data as unknown as TData
    }

    const isFetching = newState.fetchStatus === 'fetching'
    const isPending = status === 'pending'
    const isError = status === 'error'

    const isLoading = isPending && isFetching
    const hasData = data !== undefined

    const result: QueryObserverBaseResult<TData, TError> = {
      status,
      fetchStatus: newState.fetchStatus,
      isPending,
      isSuccess: status === 'success',
      isError,
      isInitialLoading: isLoading,
      isLoading,
      data,
      dataUpdatedAt: newState.dataUpdatedAt,
      error,
      errorUpdatedAt,
      failureCount: newState.fetchFailureCount,
      failureReason: newState.fetchFailureReason,
      errorUpdateCount: newState.errorUpdateCount,
      isFetched: newState.dataUpdateCount > 0 || newState.errorUpdateCount > 0,
      isFetchedAfterMount:
        newState.dataUpdateCount > queryInitialState.dataUpdateCount ||
        newState.errorUpdateCount > queryInitialState.errorUpdateCount,
      isFetching,
      isRefetching: isFetching && !isPending,
      isLoadingError: isError && !hasData,
      isPaused: newState.fetchStatus === 'paused',
      isPlaceholderData,
      isRefetchError: isError && hasData,
      isStale: isStale(query, options),
      refetch: this.refetch,
    }

    return result as QueryObserverResult<TData, TError>
  }
}
```

ë§ˆì§€ë§‰ìœ¼ë¡œ, `QueryObserver` ë¥¼ êµ¬ë…í•˜ê³  ìˆëŠ” ë¦¬ì•¡íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ê²Œ ë³€í™”ë¥¼ ì•Œë¦¬ê¸° ìœ„í•´ì„œ ë‚´ë¶€ì— `notify` ë©”ì†Œë“œê°€ ì¡´ì¬í•©ë‹ˆë‹¤.

`updateResult` ë©”ì†Œë“œê°€ í˜¸ì¶œë˜ì–´ì„œ ê²°ê³¼ ê°’ì´ ë°˜ì˜ë˜ë©´ ìµœì¢…ì ìœ¼ë¡œ `notify` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•´ì„œ êµ¬ë…í•˜ê³  ìˆëŠ” ì»´í¬ë„ŒíŠ¸ë“¤ì´ ë¦¬ë Œë”ë§ë  ìˆ˜ ìˆê²Œ ì•Œë¦½ë‹ˆë‹¤.

- **5~8ë²ˆ ë¼ì¸**: ì´ QueryObserverë¥¼ êµ¬ë…í•˜ê³  ìˆëŠ” ì»´í¬ë„ŒíŠ¸ë“¤ì„ ë¦¬ë Œë”ë§ ì‹œí‚µë‹ˆë‹¤.
- **12~15ë²ˆ ë¼ì¸**: QueryCacheê°€ ì¿¼ë¦¬ ë°ì´í„°ì˜ ë³€í™”ë¥¼ ì•Œì•„ì±Œ ìˆ˜ ìˆë„ë¡ ì•Œë¦½ë‹ˆë‹¤.

```ts {5-8, 12-15} showLineNumbers
export class QueryObserver extends Subscribable<QueryObserverListener> {
  #notify(notifyOptions: NotifyOptions): void {
    notifyManager.batch(() => {
      // First, trigger the listeners
      if (notifyOptions.listeners) {
        this.listeners.forEach((listener) => {
          listener(this.#currentResult)
        })
      }

      // Then the cache listeners
      this.#client.getQueryCache().notify({
        query: this.#currentQuery,
        type: 'observerResultsUpdated',
      })
    })
  }
}
```

## ë§ˆë¬´ë¦¬

ì´ë ‡ê²Œ TanStack Queryì˜ ì½”ì–´ì—ëŠ” ì–´ë–¤ ìš”ì†Œë“¤ì´ ìˆê³ , ê°ê° ì–´ë–»ê²Œ ì´ì–´ì ¸ìˆëŠ”ì§€ë¥¼ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.  
ì†ŒìŠ¤ì½”ë“œë¥¼ ì‚´í´ë´¤ë˜ ë‚´ìš©ì„ ë‹¤ì‹œ ì •ë¦¬í•˜ìë©´,

1. `useBaseQuery` ë¥¼ ì„ ì–¸í•œ ì»´í¬ë„ŒíŠ¸ë§ˆë‹¤ `QueryObserver` ê°€ ìƒì„±ë©ë‹ˆë‹¤.
2. `QueryObserver` ëŠ” í•˜ë‚˜ì˜ `Query` í´ë˜ìŠ¤ë¥¼ êµ¬ë…í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì¿¼ë¦¬ì— ë³€í™”ë¥¼ ê°ì§€í•˜ë©´ ì»´í¬ë„ŒíŠ¸ê°€ ë¦¬ë Œë”ë§ë  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
3. `QueryClient` ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ë¶€ì—ì„œ ìºì‹±í•˜ê³  ìˆëŠ” ë°ì´í„°ë¥¼ ì‚¬ìš©ìê°€ ì¡°ì‘í•  ìˆ˜ ìˆëŠ” APIë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë‚´ë¶€ì˜ í”„ë¡œí¼í‹°ë¡œ `QueryCache`, `MutationCache` ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.
4. `QueryCache` ëŠ” ë™ì¼í•œ ì¿¼ë¦¬ í•´ì‰¬ê°’ì„ ê°–ê³  ìˆëŠ” `Query` ê°ì²´ë¥¼ ë‹¨ì¼ë¡œ ê´€ë¦¬í•˜ê³ ì `Map` ìë£Œêµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.
5. `Query` ëŠ” ê° ì¿¼ë¦¬ê°€ ê°–ê³  ìˆëŠ” ìƒíƒœì˜ ê´€ë¦¬ ë° ë„¤íŠ¸ì›Œí¬ ìš”ì²­ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë¦¬ì•¡íŠ¸ì—ì„œ `useQuery` ë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ë¶€í„°ì˜ ì‹¤í–‰ íë¦„ì„ ì•Œì•„ë³´ê³ ì í•©ë‹ˆë‹¤.

## References

[[React Query] useQuery ë™ì‘ì›ë¦¬(1)](https://www.timegambit.com/blog/digging/react-query/01?disclosure=true)  
[Inside React Query](https://tkdodo.eu/blog/inside-react-query)
