---
title: Reactì˜ Hook ì‚´í´ë³´ê¸°
date: '2024-05-05'
lastmod: '2024-05-05'
tags: ['react', 'fiber', 'hook']
draft: false
summary: 'Reactì˜ Hookì˜ êµ¬í˜„ ë‚´ìš©ì„ ì‚´í´ë³´ëŠ” ë°©ë²•ì„ ì•Œì•„ë´¤ìŠµë‹ˆë‹¤.'
---

## ì„œë¡ 

JSì—ì„œ í•¨ìˆ˜ëŠ” ìƒì„±ì í•¨ìˆ˜ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ìƒ ìƒíƒœë¥¼ ê°€ì§ˆ ìˆ˜ ì—†ì—ˆê¸°ì—, ë¦¬ì•¡íŠ¸ë¡œ ê°œë°œí•˜ë©´ì„œ ìƒíƒœë¥¼ ê°€ì§„ ì»´í¬ë„ŒíŠ¸ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” í´ë˜ìŠ¤ ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•´ì•¼ë§Œ í–ˆì—ˆìŠµë‹ˆë‹¤.

ê·¸ëŸ°ë° ë¦¬ì•¡íŠ¸ v16.8 ë²„ì „ì—ì„œ Hookì´ ë“±ì¥í•˜ë©´ì„œ ë“œë””ì–´ í•¨ìˆ˜ ì»´í¬ë„ŒíŠ¸ë„ ìƒíƒœë¥¼ ê°€ì§ˆ ìˆ˜ ìˆê²Œ ë˜ì—ˆëŠ”ë°, ì–´ë–»ê²Œ í•¨ìˆ˜ì—ì„œ ì´ë ‡ê²Œ ë§ˆë²•ê³¼ ê°™ì€ ì¼ì´ ì¼ì–´ë‚  ìˆ˜ ìˆëŠ”ì§€ `useState` ì˜ ë™ì‘ ì›ë¦¬ê°€ ê¶ê¸ˆí–ˆì—ˆìŠµë‹ˆë‹¤.

ì–´ë ´í’‹ì´ í´ë¡œì €ë¥¼ í†µí•´ì„œ ìƒíƒœë¥¼ ë³´ê´€í•˜ê³  ìˆë‹¤ê³  í•˜ëŠ”ë°, ì´ë²ˆì— ê¶ê¸ˆì ì„ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ë¦¬ì•¡íŠ¸ í†ºì•„ë³´ê¸° ì‹œë¦¬ì¦ˆì™€ ëª¨ë˜ ë¦¬ì•¡íŠ¸ ë”¥ë‹¤ì´ë¸Œ ìŠ¤í„°ë””ë¥¼ í†µí•´ ë¦¬ì•¡íŠ¸ì˜ ë‚´ë¶€ ì½”ë“œë¥¼ íŒŒì•…í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì•Œê²Œ ë˜ì—ˆê³  ë‚˜ë¦„ëŒ€ë¡œ ì´í•´í–ˆë˜ ë‚´ìš©ì„ ê¸°ë¡í•´ë³´ê³ ì í•©ë‹ˆë‹¤.

ì´ë²ˆ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ë©´ì„œ í•´ê²°í•˜ê³ ì í•˜ëŠ” ê¶ê¸ˆì ì€ í¬ê²Œ ë‘ ê°€ì§€ì…ë‹ˆë‹¤.

> 1. Hookì˜ êµ¬í˜„ ë¶€ë¶„ì„ ì‚´í´ë³´ë ¤ë©´ ì–´ëŠ ë¶€ë¶„ì„ ì°¾ì•„ì•¼ í• ê¹Œ?
> 2. ë°˜ë“œì‹œ Hookì„ ë¦¬ì•¡íŠ¸ ì»´í¬ë„ŒíŠ¸ë‚˜ ì»¤ìŠ¤í…€ í›…ì˜ ìµœìƒë‹¨ì— ì„ ì–¸í•´ì•¼ë§Œ í•˜ëŠ” ì´ìœ ê°€ ë¬´ì—‡ì¼ê¹Œ?

ë¦¬ì•¡íŠ¸ v18.2 ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

## Fiber

Hookì´ êµ¬í˜„ë˜ì–´ ìˆëŠ” ì½”ë“œë¥¼ ì´í•´í•˜ê¸° ìœ„í•´ì„œëŠ”, ë¨¼ì € Fiber ë…¸ë“œì— ëŒ€í•œ ì´í•´ê°€ í•„ìš”í–ˆìŠµë‹ˆë‹¤.

ì™œëƒí•˜ë©´ ì»´í¬ë„ŒíŠ¸ ì•ˆì—ì„œ ì‚¬ìš©ë˜ëŠ” Hookì€ ê²°êµ­ ì»´í¬ë„ŒíŠ¸ë¥¼ í‘œí˜„í•˜ëŠ” Fiber ë…¸ë“œì— ë³´ê´€ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

Fiber ë…¸ë“œëŠ” **ë¦¬ì•¡íŠ¸ê°€ ì»´í¬ë„ŒíŠ¸ì— ëŒ€í•œ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´**ë¡œ, ì»´í¬ë„ŒíŠ¸ì˜ ìƒíƒœ, í”„ë¡œí¼í‹°, ë‹¤ë¥¸ Fiber ë…¸ë“œì™€ì˜ ì—°ê²° ì •ë³´ë“±ì˜ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ë¦¬ì•¡íŠ¸ê°€ ì´ëŸ¬í•œ Fiber ë…¸ë“œë¥¼ ê´€ë¦¬í•˜ë©´ì„œ ì¬ì¡°ì • ê³¼ì •ì—ì„œ ë¶ˆí•„ìš”í•œ DOM ì—…ë°ì´íŠ¸ë¥¼ ìƒëµí•˜ê³ , ì‹¤ì œ DOMì— Commití•´ì•¼ í•  ì‘ì—…ì„ ê²°ì •í•˜ê²Œ ë©ë‹ˆë‹¤.

ê¸°ì¡´ì—ëŠ” Stack ì•„í‚¤í…ì²˜ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì—ˆê¸°ì— Run-to-Completion ë°©ì‹ìœ¼ë¡œ ë™ì‘í•˜ì—¬ Render ê³¼ì •ì„ ì¤‘ê°„ì— ë©ˆì¶œ ìˆ˜ ì—†ë‹¤ëŠ” ë¬¸ì œì ì´ ìˆì—ˆì§€ë§Œ, 16 ë²„ì „ë¶€í„°ëŠ” Fiber ì•„í‚¤í…ì²˜ë¥¼ ì‚¬ìš©í•˜ë©´ì„œ **ìš°ì„ ìˆœìœ„ê°€ ë‚®ì€ ì‘ì—…ì„ ìœ ì˜ˆí•˜ê±°ë‚˜ ê¸°ì¡´ì˜ ì‘ì—…ì„ ì¤‘ë‹¨í•˜ëŠ” ê²ƒ**ì´ ê°€ëŠ¥í•´ì¡Œë‹¤ê³  í•©ë‹ˆë‹¤.

![Hookì´ Fiberì—ì„œ ë³´ê´€ë˜ëŠ” ì „ì²´ì ì¸ ê·¸ë¦¼](/static/images/2024/05/react-hooks/fiber.png)

ë¨¼ì € ì œê°€ ì´í•´í•œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ Hookì´ Fiber ë…¸ë“œì— ë³´ê´€ë˜ëŠ” êµ¬ì¡°ë¥¼ ê·¸ë ¤ë³´ì•˜ìŠµë‹ˆë‹¤.

- **Fiber**: íŠ¹ì • ë¦¬ì•¡íŠ¸ ì»´í¬ë„ŒíŠ¸ì— ëŒ€í•œ ì •ë³´ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ë¡œ, ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©ëœ Hookì— ëŒ€í•œ ì •ë³´ë“¤ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. _(memoizedState í”„ë¡œí¼í‹°ì— Hook ê°ì²´ê°€ ë³´ê´€ë©ë‹ˆë‹¤.)_
- **Hook**: `useState`, `useEffect` ë“± ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œ ì‚¬ìš©ëœ Hookì— ëŒ€í•œ ì •ë³´ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ì…ë‹ˆë‹¤. ê° Hookì€ ì—°ê²° ë¦¬ìŠ¤íŠ¸ë¥¼ í†µí•´ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
- **UpdateQueue**: ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” Dispatch í•¨ìˆ˜ì™€, ë‹¤ìŒìœ¼ë¡œ ì‹¤í–‰í•´ì•¼ í•  `Update` ê°ì²´ë¥¼ ê°€ë¦¬í‚¤ê³  ìˆëŠ” ê°ì²´ì…ë‹ˆë‹¤. _(pending í”„ë¡œí¼í‹°ëŠ” ê°€ì¥ ìµœê·¼ì— í˜¸ì¶œí–ˆë˜ Dispatch í•¨ìˆ˜ì— ëŒ€í•œ Updateë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤.)_
- **Update**: ìƒíƒœ ì—…ë°ì´íŠ¸ì— ëŒ€í•œ ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ” ê°ì²´ë¡œ, í•œ ë²ˆì˜ ìŠ¤ì¼€ì¤„ë§ ë‹¨ìœ„ì— ì‹¤í–‰í•´ì•¼ í•˜ëŠ” `setState` ì˜ í˜¸ì¶œ íšŸìˆ˜ë§Œí¼ ìƒì„±ë©ë‹ˆë‹¤. ë˜í•œ ì›í˜• ì—°ê²° ë¦¬ìŠ¤íŠ¸ë¡œ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ ë¶€ë¶„ì€ [ReactInternalTypes.js](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactInternalTypes.js#L67) íŒŒì¼ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts
export type Fiber = {|
  tag: WorkTag,

  // Unique identifier of this child.
  key: null | string,

  // The value of element.type which is used to preserve the identity during
  // reconciliation of this child.
  elementType: any,

  // The resolved function/class/ associated with this fiber.
  type: any,

  // The local state associated with this fiber.
  stateNode: any,

  return: Fiber | null,

  // Singly Linked List Tree Structure.
  child: Fiber | null,
  sibling: Fiber | null,
  index: number,

  // The ref last used to attach this node.
  // I'll avoid adding an owner field for prod and model that as functions.
  ref:
    | null
    | (((handle: mixed) => void) & {_stringRef: ?string, ...})
    | RefObject,

  // Input is the data coming into process this fiber. Arguments. Props.
  pendingProps: any, // This type will be more specific once we overload the tag.
  memoizedProps: any, // The props used to create the output.

  // A queue of state updates and callbacks.
  updateQueue: mixed,

  // The state used to create the output
  memoizedState: any,

  // Dependencies (contexts, events) for this fiber, if it has any
  dependencies: Dependencies | null,

  // Effect
  flags: Flags,
  subtreeFlags: Flags,
  deletions: Array<Fiber> | null,

  // Singly linked list fast path to the next fiber with side-effects.
  nextEffect: Fiber | null,

  // The first and last fiber with side-effect within this subtree. This allows
  // us to reuse a slice of the linked list when we reuse the work done within
  // this fiber.
  firstEffect: Fiber | null,
  lastEffect: Fiber | null,

  // This is a pooled version of a Fiber. Every fiber that gets updated will
  // eventually have a pair. There are cases when we can clean up pairs to save
  // memory if we need to.
  alternate: Fiber | null,
|};

export type Hook = {|
  memoizedState: any,
  baseState: any,
  baseQueue: Update<any, any> | null,
  queue: any,
  next: Hook | null,
|};

export type UpdateQueue<S, A> = {|
  pending: Update<S, A> | null,
  lanes: Lanes,
  dispatch: (A => mixed) | null,
  lastRenderedReducer: ((S, A) => S) | null,
  lastRenderedState: S | null,
|};

export type Update<S, A> = {|
  lane: Lane,
  action: A,
  hasEagerState: boolean,
  eagerState: S | null,
  next: Update<S, A>,
|};
```

## Hookì˜ êµ¬í˜„ ë¶€ë¶„ ì‚´í´ë³´ê¸°

### 1. ì¸í„°í˜ì´ìŠ¤ ì°¾ê¸°

Reactì—ëŠ” `react`, `react-dom`, `react-scheduler`, `react-reconciler` ë“± ë‹¤ì–‘í•œ íŒ¨í‚¤ì§€ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.  
ìì£¼ ì‚¬ìš©í•˜ëŠ” `useState` ì™€ ê°™ì€ í›…ì€ `react` íŒ¨í‚¤ì§€ì—ì„œ ê°€ì ¸ì˜¤ë‹¤ë³´ë‹ˆ, [packages/react/index.ts](https://github.com/facebook/react/blob/v18.2.0/packages/react/index.js#L83) ë¥¼ ë¨¼ì € ì°¾ì•˜ê³ , ì´ì–´ì„œ [packages/react/src/React.js](https://github.com/facebook/react/blob/v18.2.0/packages/react/src/React.js#L58) ì—ì„œëŠ” [packages/react/src/ReactHooks.js](https://github.com/facebook/react/blob/v18.2.0/packages/react/src/ReactHooks.js#L83) íŒŒì¼ì—ì„œ í›…ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í•¨ìˆ˜ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆë‹¤ëŠ” ì ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚´í´ë³´ë©´, í›…ì˜ ì‹¤ì œ êµ¬í˜„ ë‚´ìš©ì´ ì´ íŒ¨í‚¤ì§€ì— ë“¤ì–´ìˆëŠ” ê²ƒì´ ì•„ë‹ˆë¼, **ì™¸ë¶€ì—ì„œ Dispatcherë¥¼ ì£¼ì…ë°›ê³ , ë‹¨ìˆœíˆ ê·¸ Dispatcherì— ë“±ë¡ëœ ë©”ì†Œë“œë§Œ í˜¸ì¶œ**í•˜ê³  ìˆë‹¤ëŠ” ì ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts:react/src/ReactHooks.js showLineNumbers {3, 11}
export function useState<S>(initialState: (() => S) | S): [S, Dispatch<BasicStateAction<S>>] {
  const dispatcher = resolveDispatcher()
  return dispatcher.useState(initialState)
}

export function useEffect(
  create: () => (() => void) | void,
  deps: Array<mixed> | void | null
): void {
  const dispatcher = resolveDispatcher()
  return dispatcher.useEffect(create, deps)
}
```

### 2. resolveDispatcher

ê·¸ë˜ì„œ ê° Hookì˜ ë©”ì†Œë“œë¥¼ ë“±ë¡í•´ ë†“ì€ Dispatcherë¥¼ ê°€ì ¸ì˜¤ëŠ” `resolveDispatcher` í•¨ìˆ˜ì— ëŒ€í•´ì„œ ì°¾ì•„ë´ì•¼ í•˜ëŠ”ë°,

[ReactHooks.js](https://github.com/facebook/react/blob/v18.2.0/packages/react/src/ReactHooks.js#L24) íŒŒì¼ì„ ì‚´í´ë³´ë©´ `resolveDispatcher` í•¨ìˆ˜ì˜ ì—­í• ë„ ë‹¨ìˆœíˆ `ReactCurrentDispatcher` ê°ì²´ì˜ `current` í”„ë¡œí¼í‹°ë¥¼ ê°€ì ¸ì˜¬ ë¿ì´ë¼ëŠ” ì‚¬ì‹¤ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts:react/src/ReactHooks.js showLineNumbers
import ReactCurrentDispatcher from './ReactCurrentDispatcher'

function resolveDispatcher() {
  const dispatcher = ReactCurrentDispatcher.current;

  return ((dispatcher: any): Dispatcher);
}
```

ë˜í•œ `ReactCurrentDispatcher` ë¥¼ íŒŒì•…í•´ë³´ê³ ì [ReactCurrentDispatcher.js](https://github.com/facebook/react/blob/v18.2.0/packages/react/src/ReactCurrentDispatcher.js) íŒŒì¼ì„ í™•ì¸í•´ë„ ê°„ë‹¨í•œ ê°ì²´ ì •ì˜ë§Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts:react/src/ReactCurrentDispatcher.js showLineNumbers
import type { Dispatcher } from 'react-reconciler/src/ReactInternalTypes'

const ReactCurrentDispatcher = {
  /**
   * @internal
   * @type {ReactComponent}
   */
  current: (null: null | Dispatcher)
}

export default ReactCurrentDispatcher
```

### 3. Disptcherë¥¼ ë“±ë¡í•˜ëŠ” ìœ„ì¹˜ ì°¾ê¸°

ê·¸ë˜ì„œ `ReactCurrentDispatcher.current` ê°’ì´ ì–¸ì œ ë“±ë¡ë˜ëŠ”ì§€ì˜ ìœ„ì¹˜ë¥¼ ì°¾ì•„ë´ì•¼ í–ˆìŠµë‹ˆë‹¤.

ì´ë¥¼ ì•Œì•„ë³´ê¸° ìœ„í•œ ê°€ì¥ ë‹¨ìˆœí•œ ë°©ë²•ìœ¼ë¡œ, í”„ë¡œí¼í‹°ì— ëŒ€ì… ì—°ì‚°ìë¡œ ê°’ì´ ë³€ê²½í–ˆë˜ ë¶€ë¶„ì„ ì°¾ì•„ë³´ì•˜ìŠµë‹ˆë‹¤.

![Dispatcherë¥¼ ë“±ë¡í•˜ëŠ” ìœ„ì¹˜](/static/images/2024/05/react-hooks/react-current-dispatcher.png)

ê·¸ ê²°ê³¼ [renderWithHooks](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactFiberHooks.new.js#L374) í•¨ìˆ˜ì—ì„œ Dispatcherë¥¼ ë“±ë¡í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆê³ , ë•ë¶„ì— ì‚¬ìš©ì ì…ì¥ì—ì„œëŠ” `useState` ì²˜ëŸ¼ ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œ **ë™ì¼í•œ í›…ì„ ì‚¬ìš©í–ˆì§€ë§Œ ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ ë˜ëŠ” ìƒí™©ì¸ì§€, ì—…ë°ì´íŠ¸ë˜ëŠ” ìƒí™©ì¸ì§€ì— ë”°ë¼ ë‹¤ë¥¸ í•¨ìˆ˜ê°€ ì‚¬ìš©**ë˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

```ts:react-reconciler/src/ReactFiberHooks.new.js {9-12, 20-22, 28} showLineNumbers
export function renderWithHooks<Props, SecondArg>(
  current: Fiber | null,
  workInProgress: Fiber,
  Component: (p: Props, arg: SecondArg) => any,
  props: Props,
  secondArg: SecondArg,
  nextRenderLanes: Lanes
): any {
  ReactCurrentDispatcher.current =
    current === null || current.memoizedState === null
      ? HooksDispatcherOnMount
      : HooksDispatcherOnUpdate

  let children = Component(props, secondArg)

  if (didScheduleRenderPhaseUpdateDuringThisPass) {
    let numberOfReRenders: number = 0
    do {
      // ... ìƒëµ
      ReactCurrentDispatcher.current = __DEV__
        ? HooksDispatcherOnRerenderInDEV
        : HooksDispatcherOnRerender

      children = Component(props, secondArg)
    } while (didScheduleRenderPhaseUpdateDuringThisPass)
  }

  ReactCurrentDispatcher.current = ContextOnlyDispatcher
}
```

ê·¸ë¦¬ê³  ìƒí™© ë³„ë¡œ ì‹¤í–‰í•´ì•¼ í•  í›…ì„ ë‹´ì€ Dispatcher ê°ì²´ëŠ” [ì—¬ê¸°](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactFiberHooks.new.js#L2427)ì„œ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

```ts:react-reconciler/src/ReactFiberHooks.new.js showLineNumbers
const HooksDispatcherOnMount: Dispatcher = {
  useEffect: mountEffect,
  useState: mountState,
  // ... ìƒëµ
}

const HooksDispatcherOnUpdate: Dispatcher = {
  useEffect: updateEffect,
  useState: updateState,
  // ... ìƒëµ
}

const HooksDispatcherOnRerender: Dispatcher = {
  useEffect: updateEffect,
  useState: rerenderState,
  // ... ìƒëµ
}

export const ContextOnlyDispatcher: Dispatcher = {
  useEffect: throwInvalidHookError,
  useState: throwInvalidHookError,
  // ... ìƒëµ
}
```

ì¦‰, `useState` ì™€ ê°™ì€ í›…ì„ ì‚¬ìš©í•˜ë©´, `ReactCurrentDispatcher.current` ì—ì„œ ìƒí™©ì— ë”°ë¼ ë‹¤ë¥¸ Dispatcher ê°ì²´ë¥¼ í• ë‹¹ë°›ì•„ì„œ í•´ë‹¹ Dispatcher ê°ì²´ì— ë“±ë¡ëœ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ê²Œ ë©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ `renderWithHooks` í•¨ìˆ˜ì—ì„œ í˜„ì¬ ë Œë”ë§í•˜ë ¤ëŠ” ì»´í¬ë„ŒíŠ¸ì˜ íŒŒì´ë²„ ë…¸ë“œë¥¼ ë‚˜íƒ€ë‚´ëŠ” `current` ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ë§ˆìš´íŠ¸ ë‹¨ê³„ì´ë‹ˆ `mountState` í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ê³ , `current.memoizedState` ê°€ ì¡´ì¬í•œë‹¤ë©´ ì—…ë°ì´íŠ¸ ë‹¨ê³„ì´ë‹ˆ `updateState` í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

## ìƒíƒœ ì„ ì–¸

ì´ì œ ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œ `useState` ë¥¼ í˜¸ì¶œí•  ë•Œì˜ ë™ì‘ì„ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.  
ë¨¼ì € ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë  ë•Œì—ëŠ” `mountState` í•¨ìˆ˜ê°€ í˜¸ì¶œë  ê²ƒì´ê¸°ì— ì´ í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.  
ê·¸ëŸ°ë° `mountState` í•¨ìˆ˜ ë‚´ë¶€ì—ì„œëŠ” `mountWorkInProgressHook` í•¨ìˆ˜ë¥¼ í†µí•´ì„œ Hook ê°ì²´ë¥¼ ìƒì„±í•˜ê³  ìˆê¸°ì—, ë¨¼ì € `mountWorkInProgressHook` í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.

### mountWorkInProgressHook

[mountWorkInProgressHook](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactFiberHooks.new.js#L636) í•¨ìˆ˜ëŠ” ìƒˆë¡œìš´ Hook ê°ì²´ë¥¼ ìƒì„±í•˜ê³ , ì´ì „ì— ìƒì„±ëœ Hook ê°ì²´ê°€ ì¡´ì¬í•œë‹¤ë©´ ì—°ê²° ë¦¬ìŠ¤íŠ¸ì˜ ëì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. ë¦¬ì•¡íŠ¸ ì»´í¬ë„ŒíŠ¸ë‚˜ ì»¤ìŠ¤í…€ í›… ì•ˆì—ì„œ ì‚¬ìš©ëœ í›… ê°ì²´ëŠ” Fiber ë…¸ë“œ ë‚´ë¶€ì— `memoizedState` ì— ë“¤ì–´ê°€ê²Œ ë©ë‹ˆë‹¤.

`memoizedState` ì—ëŠ” ê°€ì¥ ì²˜ìŒìœ¼ë¡œ ì„ ì–¸í–ˆë˜ Hook ê°ì²´ë§Œ ë“¤ì–´ê°€ê¸°ì—, ë‹¤ìŒìœ¼ë¡œ ì‚¬ìš©í–ˆë˜ í›…ì˜ ìƒíƒœë„ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ `next` í”„ë¡œí¼í‹°ë¡œ í›… ê°ì²´ ê°„ì˜ ì—°ê²° ê´€ê³„ë¥¼ ë§ºì–´ì£¼ëŠ” ê²ƒì…ë‹ˆë‹¤.

ì´ í•¨ìˆ˜ì˜ ì—­í• ì„ ì •ë¦¬í•˜ìë©´ ë‹¨ìˆœí•©ë‹ˆë‹¤.

- **2ì¤„**: ìƒˆë¡œìš´ Hook ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
- **14ì¤„**: ë§Œì•½ ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œ ì²˜ìŒìœ¼ë¡œ ì„ ì–¸ëœ í›…ì´ë¼ë©´, íŒŒì´ë²„ ë…¸ë“œì˜ `memoizedState` ì— Hook ê°ì²´ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.
- **17ì¤„**: ê·¸ë ‡ì§€ ì•Šë‹¤ë©´, ì—°ê²° ë¦¬ìŠ¤íŠ¸ì˜ ëì— ì¶”ê°€í•©ë‹ˆë‹¤.

> ğŸ’¡ **ì˜ë¬¸ì **  
> ì»´í¬ë„ŒíŠ¸ ì•ˆì—ì„œ ì‚¬ìš©í–ˆë˜ í›…ì„ ë³´ê´€í•˜ëŠ” ë° ë°°ì—´ì´ ì•„ë‹Œ ì—°ê²° ë¦¬ìŠ¤íŠ¸ë¡œ êµ¬í˜„í•œ ì´ìœ ê°€ ê¶ê¸ˆí•´ì§‘ë‹ˆë‹¤. íŠ¹íˆ í›…ì´ ì•„ì§ ì •ì‹ ë²„ì „ìœ¼ë¡œ ë“¤ì–´ì˜¤ê¸° ì „ì— ì˜¬ë¼ì™”ë˜ í¬ìŠ¤íŒ…ì¸ [React hooks: not magic, just arrays
> ](https://medium.com/@ryardley/react-hooks-not-magic-just-arrays-cd4f1857236e) ì—ì„œëŠ” í›…ì´ ë°°ì—´ë¡œ êµ¬í˜„ë˜ì–´ ìˆë‹¤ê³  ì„¤ëª…í•˜ê³  ìˆì–´ì„œ, ì´ˆì°½ê¸°ì—ëŠ” ë°°ì—´ì´ì—ˆë‹¤ê°€ ì´í›„ì— ì—°ê²° ë¦¬ìŠ¤íŠ¸ë¡œ êµ¬í˜„ ë°©ì‹ì„ ë³€ê²½í•˜ê²Œ ëœ ê²ƒì¸ì§€ ê¶ê¸ˆì ì´ ìƒê²¼ìŠµë‹ˆë‹¤.

```ts:react-reconciler/src/ReactFiberHooks.new.js {2, 14, 17} showLineNumbers
function mountWorkInProgressHook(): Hook {
  const hook: Hook = {
    memoizedState: null,

    baseState: null,
    baseQueue: null,
    queue: null,

    next: null,
  };

  if (workInProgressHook === null) {
    // This is the first hook in the list
    currentlyRenderingFiber.memoizedState = workInProgressHook = hook;
  } else {
    // Append to the end of the list
    workInProgressHook = workInProgressHook.next = hook;
  }
  return workInProgressHook;
}
```

### mountState

[mountState](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactFiberHooks.new.js#L1505) ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ì²˜ìŒ ë§ˆìš´íŠ¸ ë˜ëŠ” ë‹¨ê³„ì—ì„œ ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œ `useState` í›…ì˜ ì„ ì–¸ì´ ìˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.

- **4ì¤„**: ìƒˆë¡œìš´ Hook ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
- **9ì¤„**: Hook ê°ì²´ì˜ `memoizedState` ì— ê°œë°œìê°€ ì´ˆê¸°ê°’ìœ¼ë¡œ ì „ë‹¬í•œ ìƒíƒœë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.
- **20ì¤„**: ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” `dispatchSetState` í•¨ìˆ˜ì— ê³ ì •ëœ íŒŒë¼ë¯¸í„°ë¥¼ ì „ë‹¬í•˜ì—¬ `dispatch` í•¨ìˆ˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì´ `dispatch` í•¨ìˆ˜ëŠ” ê°œë°œìê°€ ì‚¬ìš©í•˜ëŠ” `setState` í•¨ìˆ˜ë¡œ, í˜¸ì¶œ ì‹œ ì¬ì¡°ì • ê³¼ì •ì— ë”°ë¼ ë¦¬ë Œë”ë§ì´ í•„ìš”í•˜ë‹¤ë©´ ìŠ¤ì¼€ì¤„ëŸ¬ì—ê²Œ ì‘ì—…ì„ ìš”ì²­í•©ë‹ˆë‹¤.
- **25ì¤„**: ê°œë°œìê°€ `useState` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ ë°˜í™˜ ê°’ìœ¼ë¡œ ë°›ëŠ” ë°°ì—´ì„ ë°˜í™˜í•©ë‹ˆë‹¤.

```ts:react-reconciler/src/ReactFiberHooks.new.js {4, 9, 10, 20, 25} showLineNumbers
function mountState<S>(
  initialState: (() => S) | S,
): [S, Dispatch<BasicStateAction<S>>] {
  const hook = mountWorkInProgressHook();
  if (typeof initialState === 'function') {
    // $FlowFixMe: Flow doesn't like mixed types
    initialState = initialState();
  }
  hook.memoizedState = hook.baseState = initialState;
  const queue: UpdateQueue<S, BasicStateAction<S>> = {
    pending: null,
    lanes: NoLanes,
    dispatch: null,
    lastRenderedReducer: basicStateReducer,
    lastRenderedState: (initialState: any),
  };
  hook.queue = queue;
  const dispatch: Dispatch<
    BasicStateAction<S>,
  > = (queue.dispatch = (dispatchSetState.bind(
    null,
    currentlyRenderingFiber,
    queue,
  ): any));
  return [hook.memoizedState, dispatch];
}
```

### updateWorkInProgressHook

ì´ì œ ì´ì–´ì„œ ì»´í¬ë„ŒíŠ¸ê°€ ì—…ë°ì´íŠ¸ë  ë•Œ í˜¸ì¶œë˜ëŠ” `updateState` í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ê¸°ì— ì•ì„œ í›… ê°ì²´ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” [updateWorkInProgressHook](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactFiberHooks.new.js#L657) í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.

> ğŸ’¡ **ì „ì œ ì‚¬í•­**  
> ReactëŠ” ìƒˆë¡­ê²Œ ë Œë”ë§í•˜ë ¤ê³  í•˜ëŠ” ì‘ì—…ë¬¼ì„ ì„ì‹œì˜ `workInProgress` ë¼ëŠ” ê³³ì—ì„œ ì²˜ë¦¬í•˜ë‹¤ê°€, ì‘ì—…ì´ ì™„ë£Œë˜ë©´ `current` ì— ë°˜ì˜í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ë”ë¸” ë²„í¼ë§ ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ìƒˆë¡œìš´ ì‘ì—…ì„ ì²˜ë¦¬í•˜ë‹¤ê°€ë„ ìš°ì„ ìˆœìœ„ê°€ ë” ë†’ì€ ì‘ì—…ì´ ìˆë‹¤ë©´ ê¸°ì¡´ì˜ ì‘ì—…ì„ ì¤‘ë‹¨í•˜ëŠ” ê²ƒì— ìš©ì´í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

> ê·¸ë˜ì„œ ë¦¬ì•¡íŠ¸ ì†ŒìŠ¤ì½”ë“œ ë‚´ë¶€ì—ì„œ ì „ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” í”„ë¡œí¼í‹°ì˜ ì˜ë¯¸ë¥¼ ì—¼ë‘í•˜ê³  ìˆë‹¤ë©´, ì½”ë“œë¥¼ ì´í•´í•˜ê¸°ì— ë” ìˆ˜ì›”í•  ê²ƒì…ë‹ˆë‹¤.  
> **current**: ì´ë¯¸ ê¸°ì¡´ì— ë Œë”ë§ë˜ì–´ ìˆëŠ” Fiber ë…¸ë“œ or Hook ê°ì²´ ë“±ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.  
> **workInProgress**: í˜„ì¬ ìƒˆë¡­ê²Œ ë Œë”ë§í•˜ë ¤ê³  í•˜ëŠ” Fiber ë…¸ë“œ or Hook ê°ì²´ ë“±ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.  
> **alternate**: current ê¸°ì¤€ìœ¼ë¡œëŠ” workInProgress, workInProgress ê¸°ì¤€ìœ¼ë¡œëŠ” currentë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„°ì…ë‹ˆë‹¤.

```ts:react-reconciler/src/ReactFiberHooks.new.js {7, 10, 12, 18, 24, 27, 35, 43, 57, 60} showLineNumbers
function updateWorkInProgressHook(): Hook {
  // This function is used both for updates and for re-renders triggered by a
  // render phase update. It assumes there is either a current hook we can
  // clone, or a work-in-progress hook from a previous render pass that we can
  // use as a base. When we reach the end of the base list, we must switch to
  // the dispatcher used for mounts.
  let nextCurrentHook: null | Hook
  if (currentHook === null) {
    // ì²« ë²ˆì§¸ í›…ì„ ì²˜ë¦¬í•  ë•Œ
    const current = currentlyRenderingFiber.alternate
    if (current !== null) {
      nextCurrentHook = current.memoizedState
    } else {
      nextCurrentHook = null
    }
  } else {
    // ë‘ ë²ˆì§¸ ì´ìƒì˜ í›…ì„ ì²˜ë¦¬í•  ë•Œ
    nextCurrentHook = currentHook.next
  }

  let nextWorkInProgressHook: null | Hook
  if (workInProgressHook === null) {
    // ì²« ë²ˆì§¸ í›…ì„ ì²˜ë¦¬í•  ë•Œ
    nextWorkInProgressHook = currentlyRenderingFiber.memoizedState
  } else {
    // ë‘ ë²ˆì§¸ ì´ìƒì˜ í›…ì„ ì²˜ë¦¬í•  ë•Œ
    nextWorkInProgressHook = workInProgressHook.next
  }

  if (nextWorkInProgressHook !== null) {
    // ë‹¤ìŒìœ¼ë¡œ ì‘ì—…í•´ì•¼ í•  nextWorkInProgressHook í›…ì´ ì¡´ì¬í•œë‹¤ë©´, ìƒˆë¡œìš´ í›…ì„ ë§Œë“¤ì§€ ì•Šê³  ê·¸ í›…ì„ ì¬ì‚¬ìš©
    workInProgressHook = nextWorkInProgressHook
    nextWorkInProgressHook = workInProgressHook.next

    currentHook = nextCurrentHook
  } else {
    // ë‹¤ìŒìœ¼ë¡œ ì‘ì—…í•´ì•¼ í•  nextWorkInProgressHook í›…ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´, ìƒˆë¡œìš´ í›…ì„ ë§Œë“¤ì–´ì„œ ì—°ê²° ë¦¬ìŠ¤íŠ¸ì˜ ëì— ì¶”ê°€

    if (nextCurrentHook === null) {
      throw new Error('Rendered more hooks than during the previous render.')
    }

    currentHook = nextCurrentHook

    const newHook: Hook = {
      memoizedState: currentHook.memoizedState,

      baseState: currentHook.baseState,
      baseQueue: currentHook.baseQueue,
      queue: currentHook.queue,

      next: null,
    }

    if (workInProgressHook === null) {
      // This is the first hook in the list.
      currentlyRenderingFiber.memoizedState = workInProgressHook = newHook
    } else {
      // Append to the end of the list.
      workInProgressHook = workInProgressHook.next = newHook
    }
  }
  return workInProgressHook
}
```

#### nextCurrentHook

í˜„ì¬ ì²˜ë¦¬í•˜ê³  ìˆëŠ” ì»´í¬ë„ŒíŠ¸ì˜ `current` íŒŒì´ë²„ ë…¸ë“œì— ë“¤ì–´ìˆëŠ” í›… ê°ì²´ë¥¼ ì°¸ì¡°í•˜ëŠ” ì‹ë³„ìì…ë‹ˆë‹¤.

- **7ì¤„**: í›„í–‰í•˜ëŠ” ë¡œì§ì— ë”°ë¼ current íŒŒì´ë²„ ë…¸ë“œì˜ í›… ê°ì²´ê°€ `nextCurrentHook` í”„ë¡œí¼í‹°ì— í• ë‹¹ë©ë‹ˆë‹¤.
- **10ì¤„**: `currentlyRenderingFiber` ëŠ” í˜„ì¬ ì²˜ë¦¬í•˜ê³  ìˆëŠ” ì»´í¬ë„ŒíŠ¸ì˜ íŒŒì´ë²„ ë…¸ë“œì¸ `workInProgress` íŒŒì´ë²„ ë…¸ë“œë¥¼ ê°€ë¦¬í‚¤ê³  ìˆëŠ”ë°, ì´ê²ƒì˜ `alternate` ëŠ” ì´ë¯¸ ë Œë”ë§ë˜ì—ˆë˜ `current` íŒŒì´ë²„ ë…¸ë“œë¥¼ ê°€ë¦¬í‚¤ê³  ìˆìŠµë‹ˆë‹¤. ì¦‰, ì´ì „ì— ì´ë¯¸ ë Œë”ë§ë˜ì–´ ìˆëŠ” `current` íŒŒì´ë²„ ë…¸ë“œì˜ í›… ê°ì²´ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤.
- **18ì¤„**: `updateWorkInProgressHook` í•¨ìˆ˜ê°€ ì¢…ë£Œë˜ê¸° ì „ì— ì´ë¯¸ ì²˜ë¦¬í–ˆì—ˆë˜ í›… ê°ì²´ë¥¼ `currentHook` ì „ì—­ í”„ë¡œí¼í‹°ì— í• ë‹¹í•˜ëŠ”ë°, ë•ë¶„ì— ë‘ ë²ˆì§¸ ì´ìƒìœ¼ë¡œ ì„ ì–¸ëœ í›…ì„ ì²˜ë¦¬í•  ë•Œì—ëŠ” ë³µì¡í•œ ë¹„êµ ë¡œì§ ì—†ì´ ë°”ë¡œ `next` í”„ë¡œí¼í‹°ë¥¼ ì°¸ì¡°í•˜ì—¬ ë‹¤ìŒ í›… ê°ì²´ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### nextWorkInProgressHook

í˜„ì¬ ì²˜ë¦¬í•˜ê³  ìˆëŠ” ì»´í¬ë„ŒíŠ¸ì˜ `workInProgress` íŒŒì´ë²„ ë…¸ë“œì— ë“¤ì–´ìˆëŠ” í›… ê°ì²´ë¥¼ ì°¸ì¡°í•˜ëŠ” ì‹ë³„ìì…ë‹ˆë‹¤.

- **21ì¤„**: í›„í–‰í•˜ëŠ” ë¡œì§ì— ë”°ë¼ workInProgress íŒŒì´ë²„ ë…¸ë“œì˜ í›… ê°ì²´ê°€ `nextWorkInProgressHook` í”„ë¡œí¼í‹°ì— í• ë‹¹ë©ë‹ˆë‹¤.
- **24ì¤„**: ì²« ë²ˆì§¸ë¡œ ì„ ì–¸ëœ í›…ì„ ì²˜ë¦¬í•  ë•Œì—ëŠ” `workInProgress` íŒŒì´ë²„ ë…¸ë“œì˜ í›… ê°ì²´ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤.
- **27ì¤„**: ë‘ ë²ˆì§¸ ì´ìƒì˜ í›…ì„ ì²˜ë¦¬í•  ë•Œì—ëŠ” ì´ë¯¸ ì²˜ë¦¬í–ˆë˜ í›… ê°ì²´ì¸ `workInProgressHook` ì˜ `next` í¬ì¸í„°ë¥¼ í™œìš©í•˜ì—¬ ë‹¤ìŒ í›… ê°ì²´ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤.

#### currentHook

ì´ì „ì— `updateWorkInProgressHook` ê°€ ì¢…ë£Œë˜ì—ˆì„ ë•Œì˜ `nextCurrentHook` ê°’ì„ ì°¸ì¡°í•˜ëŠ” ì‹ë³„ìì…ë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ ì´ì–´ì„œ ì²˜ë¦¬í•´ì•¼ í•  í›… ê°ì²´ë¥¼ ì‘ì—…í•˜ë©´ì„œ `updateWorkInProgressHook` ê°€ ë˜ í˜¸ì¶œë˜ì—ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì´ì „ í›… ì •ë³´ë¥¼ ë³´ê´€í•˜ê³  ìˆëŠ” ê²ƒì…ë‹ˆë‹¤.

- **35ì¤„, 43ì¤„**: ë‹¤ìŒìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•  í›… ê°ì²´ë¥¼ ì²˜ë¦¬í•  ë•Œ ì´ì „ í›… ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ê¸° ìœ„í•´ì„œ `updateWorkInProgressHook` í•¨ìˆ˜ê°€ ì¢…ë£Œë˜ê¸° ì „ì— ì´ë¯¸ ì²˜ë¦¬í–ˆë˜ `nextCurrentHook` í›… ê°ì²´ë¥¼ `currentHook` ì „ì—­ í”„ë¡œí¼í‹°ì— í• ë‹¹í•©ë‹ˆë‹¤.

#### workInProgressHook

ë§ˆì°¬ê°€ì§€ë¡œ ì´ì „ì— `updateWorkInProgressHook` ê°€ ì¢…ë£Œë˜ì—ˆì„ ë•Œì˜ `nextWorkInProgressHook` ê°’ì„ ì°¸ì¡°í•˜ëŠ” ì‹ë³„ìì…ë‹ˆë‹¤.

- **57ì¤„, 60ì¤„**: ë§ˆì°¬ê°€ì§€ë¡œ ë‹¤ìŒìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•  í›… ê°ì²´ë¥¼ ìœ„í•´ì„œ ì´ë¯¸ ì²˜ë¦¬í–ˆë˜ `nextWorkInProgressHook` ê°ì²´ë¥¼ `workInProgressHook` ì „ì—­ í”„ë¡œí¼í‹°ì— í• ë‹¹í•©ë‹ˆë‹¤. ë˜í•œ í›… ê°ì²´ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.

### updateState

[updateState](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactFiberHooks.new.js#L1532) ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ëŠ” ë‹¨ê³„ì— ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œ `useState` í›…ì˜ ì„ ì–¸ì´ ìˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.

ë˜í•œ ì½”ë“œë¥¼ ì‚´í´ë³´ë©´ ì‹¤ì œ ë¡œì§ì€ `updateReducer` ì— ìœ„ì„í•˜ê³  ìˆë‹¤ëŠ” ì ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts:react-reconciler/src/ReactFiberHooks.new.js {9} showLineNumbers
function basicStateReducer<S>(state: S, action: BasicStateAction<S>): S {
  // $FlowFixMe: Flow doesn't like mixed types
  return typeof action === 'function' ? action(state) : action;
}

function updateState<S>(
  initialState: (() => S) | S,
): [S, Dispatch<BasicStateAction<S>>] {
  return updateReducer(basicStateReducer, (initialState: any));
}
```

### updateReducer

[updateReducer](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactFiberHooks.new.js#L759) ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ëŠ” ë‹¨ê³„ì— `useState` ë‚˜ `useReducer` í›…ì˜ ì„ ì–¸ì´ ìˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.

Render ë‹¨ê³„ì—ì„œ `useState` ì˜ ë°˜í™˜ ê°’ ì¤‘ ë‘ ë²ˆì§¸ë¡œ ë„˜ì–´ì˜¤ëŠ” setter í•¨ìˆ˜ì¸ `dispatchSetState` ë¥¼ í˜¸ì¶œí•˜ê²Œ ë˜ë©´ ìƒíƒœì˜ ì—…ë°ì´íŠ¸ë¥¼ ì¦‰ì‹œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ Queueì— ë„£ì–´ë‘ê³  ìˆëŠ”ë°, ì´ Queueì— ë“¤ì–´ìˆëŠ” ì—…ë°ì´íŠ¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê³¼ì •ì´ `updateReducer` ì— í¬í•¨ë˜ì–´ ìˆê¸°ë„ í•©ë‹ˆë‹¤.

Laneì´ë‚˜ Concurrent Renderingê³¼ ê´€ë ¨ëœ ë‚´ìš©ì€ ì•„ì§ ì´í•´ê°€ ë¶€ì¡±í•˜ì—¬ ìƒëµí•˜ì˜€ìŠµë‹ˆë‹¤.

- **18-30ì¤„**: ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” `dispatchSetState` ê°€ Render ë‹¨ê³„ì—ì„œ ë™ì‘í•œë‹¤ë©´, ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•˜ëŠ” ì‘ì—…ì´ Queueì— ë“¤ì–´ìˆê³  ê°€ì¥ ìµœê·¼ì— ë“±ë¡ëœ Updateë¥¼ `pending` í”„ë¡œí¼í‹°ë¡œ ê°€ë¦¬í‚¤ê³  ìˆê²Œ ë©ë‹ˆë‹¤. ê·¸ëŸ°ë° `Hook` ê°ì²´ì— ë“¤ì–´ìˆëŠ” `baseQueue` ì—ëŠ” ì•„ì§ ë“¤ì–´ê°€ì§€ ì•Šì€ ì—…ë°ì´íŠ¸ê°€ ì¡´ì¬í•  ìˆ˜ ìˆê¸°ì— ì´ë¥¼ í†µí•©í•´ì£¼ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- **54-62ì¤„**: ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” `dispatchSetState` ê°€ Render ë‹¨ê³„ê°€ ì•„ë‹ ë•Œ ìˆ˜í–‰ë˜ì—ˆë‹¤ë©´, ë¦¬ë“€ì„œ í•¨ìˆ˜ê°€ ë¯¸ë¦¬ ì‹¤í–‰ë˜ì–´ì„œ ë§Œë“¤ì–´ ì§„ ê°’ì´ `eagerState` í”„ë¡œí¼í‹°ì— ì¡´ì¬í•˜ê²Œ ë©ë‹ˆë‹¤. ê·¸ë˜ì„œ ê³„ì‚°ì´ ì´ë¯¸ ìˆ˜í–‰ë˜ì—ˆëŠ”ì§€ë¥¼ ì²´í¬í•˜ê³  ì¬í™œìš©í•˜ê±°ë‚˜ ë¦¬ë“€ì„œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì„œ ìƒˆë¡œìš´ ê°’ì„ ê³„ì‚°í•˜ëŠ” ë¡œì§ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- **74ì¤„**: í›…ì— ì´ë¯¸ ë“¤ì–´ìˆëŠ” ìƒíƒœ ê°’ê³¼ ìƒˆë¡œ ê³„ì‚°ëœ ìƒíƒœ ê°’ì´ ë‹¤ë¥´ë‹¤ë©´, ë¦¬ì•¡íŠ¸ì—ê²Œ ì´ í›…ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŒì„ ì•Œë ¤ì£¼ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ([markWorkInProgressReceivedUpdate](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L3328) í•¨ìˆ˜ëŠ” `didReceiveUpdate` í”Œë˜ê·¸ ë³€ìˆ˜ë¥¼ trueë¡œ ë§Œë“¤ì–´ ì£¼ëŠ” ë‹¨ìˆœí•œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ”ë°, ì¬ì¡°ì • ê³¼ì •ì—ì„œ ì´ í”Œë˜ê·¸ ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì—¬ ë¦¬ë Œë”ë§ì´ í•„ìš”í•œì§€ë¥¼ íŒë‹¨í•˜ëŠ” ê²ƒìœ¼ë¡œ ì¶”ì¸¡í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ ë¶€ë¶„ì€ ì¶”í›„ì— ë” ìì„¸íˆ ì‚´í´ë³¼ í•„ìš”ì„±ì„ ëŠë‚ë‹ˆë‹¤.)

```ts:react-reconciler/src/ReactFiberHooks.new.js {18-30, 54-62, 74} showLineNumbers
function updateReducer<S, I, A>(
  reducer: (S, A) => S,
  initialArg: I,
  init?: I => S,
): [S, Dispatch<A>] {
  const hook = updateWorkInProgressHook();
  const queue = hook.queue;

  queue.lastRenderedReducer = reducer;

  const current: Hook = (currentHook: any);

  // The last rebase update that is NOT part of the base state.
  let baseQueue = current.baseQueue;

  // The last pending update that hasn't been processed yet.
  const pendingQueue = queue.pending;
  if (pendingQueue !== null) {
    // We have new updates that haven't been processed yet.
    // We'll add them to the base queue.
    if (baseQueue !== null) {
      // Merge the pending queue and the base queue.
      const baseFirst = baseQueue.next;
      const pendingFirst = pendingQueue.next;
      baseQueue.next = pendingFirst;
      pendingQueue.next = baseFirst;
    }
    current.baseQueue = baseQueue = pendingQueue;
    queue.pending = null;
  }

  if (baseQueue !== null) {
    // We have a queue to process.
    const first = baseQueue.next;
    let newState = current.baseState;

    let newBaseState = null;
    let newBaseQueueFirst = null;
    let newBaseQueueLast = null;
    let update = first;
    do {
      if (newBaseQueueLast !== null) {
        const clone: Update<S, A> = {
          lane: NoLane,
          action: update.action,
          hasEagerState: update.hasEagerState,
          eagerState: update.eagerState,
          next: (null: any),
        };
        newBaseQueueLast = newBaseQueueLast.next = clone;
      }

      // Process this update.
      if (update.hasEagerState) {
        // If this update is a state update (not a reducer) and was processed eagerly,
        // we can use the eagerly computed state
        newState = ((update.eagerState: any): S);
      } else {
        const action = update.action;
        newState = reducer(newState, action);
      }
    update = update.next;
    } while (update !== null && update !== first);

    if (newBaseQueueLast === null) {
      newBaseState = newState;
    } else {
      newBaseQueueLast.next = (newBaseQueueFirst: any);
    }

    // Mark that the fiber performed work, but only if the new state is
    // different from the current state.
    if (!is(newState, hook.memoizedState)) {
      markWorkInProgressReceivedUpdate();
    }

    hook.memoizedState = newState;
    hook.baseState = newBaseState;
    hook.baseQueue = newBaseQueueLast;

    queue.lastRenderedState = newState;
  }

  const dispatch: Dispatch<A> = (queue.dispatch: any);
  return [hook.memoizedState, dispatch];
}
```

## ìƒíƒœ ì—…ë°ì´íŠ¸

### dispatchSetState

[dispatchSetState](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactFiberHooks.new.js#L2228) ëŠ” `useState` ë¡œ ì„ ì–¸í•œ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” setter í•¨ìˆ˜ì…ë‹ˆë‹¤.  
ì´ëŸ¬í•œ ì‚¬ì‹¤ì€ `mountState` ì™€ `updateReducer` í•¨ìˆ˜ì˜ ë°˜í™˜ ê°’ì„ í™•ì¸í•˜ë©´ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ë¶€ë¶„ë„ Laneì´ë‚˜ Concurrent Renderingê³¼ ê´€ë ¨ëœ ë‚´ìš©ì€ ì•„ì§ ì´í•´ê°€ ë¶€ì¡±í•˜ì—¬ ìƒíƒœ ì—…ë°ì´íŠ¸ì— ëŒ€í•œ ë‚´ìš©ë§Œ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.

- **8ì¤„**: ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸ í•  ë™ì‘ì„ ë‚˜íƒ€ë‚´ëŠ” `Update` ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
- **17ì¤„**: í˜„ì¬ Render ë‹¨ê³„ë¥¼ ì§„í–‰ì¤‘ì´ë¼ë©´, ìƒíƒœë¥¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ íì— ë„£ì–´ë‘ëŠ” ì‘ì—…ì„ í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤. [enqueueRenderPhaseUpdate](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactFiberHooks.new.js#L2318) í•¨ìˆ˜ì˜ ë‚´ìš©ì„ ì‚´í´ë³´ë©´ Update ê°ì²´ë¥¼ ì›í˜• ì—°ê²° ë¦¬ìŠ¤íŠ¸ì˜ í˜•íƒœë¡œ ë§Œë“¤ê³  ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **29ì¤„**: `lastRenderedReducer` ì—ëŠ” ê°œë°œìê°€ `useState`, `useReducer` ë¥¼ ì‚¬ìš©í•˜ë©´ì„œ ì „ë‹¬í•œ `reducer` ê°€ í• ë‹¹ë˜ì–´ ìˆë‹¤ëŠ” ì ì„ [updateReducer](https://github.com/facebook/react/blob/v18.2.0/packages/react-reconciler/src/ReactFiberHooks.new.js#L773) ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
  ê·¸ë˜ì„œ ì´ reducer í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì—¬ ìƒˆë¡œìš´ ê²°ê³¼ ê°’ì„ ë§Œë“¤ì–´ ëƒ…ë‹ˆë‹¤.
- **33ì¤„**: ë§Œì•½ ìƒˆë¡­ê²Œ ë§Œë“¤ì–´ ë‚¸ ê²°ê³¼ ê°’ì´ ê¸°ì¡´ì˜ ìƒíƒœ ê°’ê³¼ ë™ì¼í•˜ë‹¤ë©´, ì—…ë°ì´íŠ¸ë¥¼ í•´ì•¼ í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ `enqueueConcurrentHookUpdateAndEagerlyBailout` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ë’¤ ë¹ ë¥´ê²Œ ì¢…ë£Œí•©ë‹ˆë‹¤.
- **46ì¤„**: ìŠ¤ì¼€ì¤„ëŸ¬ì—ê²Œ í˜„ì¬ `fiber` ë…¸ë“œì˜ ì—…ë°ì´íŠ¸ë¥¼ ìš”ì²­í•˜ì—¬ ë¦¬ë Œë”ë§ì´ ë°œìƒí•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

```ts:react-reconciler/src/ReactFiberHooks.new.js {8, 17, 29, 33, 46} showLineNumbers
function dispatchSetState<S, A>(
  fiber: Fiber,
  queue: UpdateQueue<S, A>,
  action: A,
) {
  const lane = requestUpdateLane(fiber);

  const update: Update<S, A> = {
    lane,
    action,
    hasEagerState: false,
    eagerState: null,
    next: (null: any),
  };

  if (isRenderPhaseUpdate(fiber)) {
    enqueueRenderPhaseUpdate(queue, update);
  } else {
    const alternate = fiber.alternate;
    if (
      fiber.lanes === NoLanes &&
      (alternate === null || alternate.lanes === NoLanes)
    ) {
      const lastRenderedReducer = queue.lastRenderedReducer;
      if (lastRenderedReducer !== null) {
        let prevDispatcher;
        try {
          const currentState: S = (queue.lastRenderedState: any);
          const eagerState = lastRenderedReducer(currentState, action);

          update.hasEagerState = true;
          update.eagerState = eagerState;
          if (is(eagerState, currentState)) {
            enqueueConcurrentHookUpdateAndEagerlyBailout(fiber, queue, update);
            return;
          }
        } catch (error) {
          // Suppress the error. It will throw again in the render phase.
        }
      }
    }

    const root = enqueueConcurrentHookUpdate(fiber, queue, update, lane);
    if (root !== null) {
      const eventTime = requestEventTime();
      scheduleUpdateOnFiber(root, fiber, lane, eventTime);
      entangleTransitionUpdate(root, queue, lane);
    }
  }

  markUpdateInDevTools(fiber, lane, action);
}
```

## ë§ˆë¬´ë¦¬

ë‚´ìš©ì„ ì •ë¦¬í•˜ìë©´:

1. ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©ëœ Hookì€ Fiber ë…¸ë“œì˜ `memoizedState` ì— ì €ì¥ëœë‹¤.
2. ì»´í¬ë„ŒíŠ¸ì—ì„œ Hookì˜ ì„ ì–¸ë¶€ë¥¼ ë§Œë‚˜ë©´, ì–´ë–¤ ìƒí™©ì´ëƒì— ë”°ë¼ì„œ ë¯¸ë¦¬ ë“±ë¡ëœ Dispatcher ê°ì²´ë¥¼ í†µí•´ ë‹¤ë¥¸ í•¨ìˆ˜ê°€ ì‚¬ìš©ëœë‹¤.
   - ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë˜ëŠ” ë‹¨ê³„ì—ì„œ `useState` í›…ì˜ ì„ ì–¸ë¶€ë¥¼ ë§Œë‚˜ë©´ `mountState` í•¨ìˆ˜ê°€ í˜¸ì¶œëœë‹¤.
   - ì»´í¬ë„ŒíŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ëŠ” ë‹¨ê³„ì—ì„œ `useState` í›…ì˜ ì„ ì–¸ë¶€ë¥¼ ë§Œë‚˜ë©´ `updateState` í•¨ìˆ˜ê°€ í˜¸ì¶œëœë‹¤.
3. ê° Hookì€ ì—°ê²° ë¦¬ìŠ¤íŠ¸ë¡œ êµ¬í˜„ë˜ì–´ ìˆê³ , ì»´í¬ë„ŒíŠ¸ê°€ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ ì´ì „ì— ì²˜ë¦¬í•œ Hook ê°ì²´ì˜ `next` ì—°ê²° ì •ë³´ë¥¼ í†µí•´ ë‹¤ìŒ Hook ê°ì²´ë¥¼ ì²˜ë¦¬í•œë‹¤.

ì‹¤ì œ ì‹¤í–‰ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ë©´:

```ts
import { useState } from 'react';

const MyComponent = () => {
  const [a, setA] = useState('ì²« ë²ˆì§¸ ì„ ì–¸í•œ í›…');
  const [b, setB] = useState('ë‘ ë²ˆì§¸ ì„ ì–¸í•œ í›…');
  const [c, setC] = useState('ì„¸ ë²ˆì§¸ ì„ ì–¸í•œ í›…');

  return <div>ì•ˆë…•í•˜ì„¸ìš”</div>;
};

export default MyComponent;
```

![MyComponentì˜ íŒŒì´ë²„ ë…¸ë“œ](/static/images/2024/05/react-hooks/component-result.png)

React ì†ŒìŠ¤ì½”ë“œë¥¼ ì‚´í´ë³´ë©´ì„œ Hookì´ ì–´ë–»ê²Œ í´ë¡œì €ë¡œ êµ¬í˜„ë˜ì–´ ìˆëŠ”ì§€, ì™œ Hookì„ ìµœìƒë‹¨ì—ì„œë§Œ ì„ ì–¸í•´ì•¼ í•˜ëŠ”ì§€ ë“±ì— ëŒ€í•œ ì˜ë¬¸ì ì„ í•´ì†Œí•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

ë˜í•œ TanStack Queryì—ì„œë„ `notifyManager` ë¥¼ í†µí•´ì„œ ì—…ë°ì´íŠ¸ ì‘ì—…ì„ ë°°ì¹­ ì²˜ë¦¬ë¥¼ í•˜ê³  ìˆì—ˆëŠ”ë°, Reactì—ì„œë„ ë‚˜ë¦„ëŒ€ë¡œì˜ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ í™œìš©í•˜ê³  ìˆëŠ” ì ì„ ë³´ì•„ ì¢‹ì€ ì•„í‚¤í…ì²˜ë¥¼ ì´í•´í•˜ë ¤ê³  ë…¸ë ¥í•˜ë‹¤ë³´ë©´ ìœ ì‚¬í•œ ì•„ì´ë””ì–´ë¡œ êµ¬í˜„ëœ ë¶€ë¶„ì„ ë¹ ë¥´ê²Œ íŒŒì•…í•  ìˆ˜ ìˆê³  í‰ì†Œì— ì‚¬ìš©í•˜ê³  ìˆëŠ” íŒ¨í‚¤ì§€ì˜ ë™ì‘ ì›ë¦¬ë¥¼ ë¹ ë¥´ê²Œ íŒŒì•…í•˜ë©° ì„œë¹„ìŠ¤ì— ì ìš©í•˜ë©´ì„œ ë°œìƒí•˜ëŠ” ì´ìŠˆë¥¼ í•´ê²°í•˜ëŠ” ê²ƒì—ë„ ë„ì›€ì´ ë˜ê² ë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤.

ì•ìœ¼ë¡œ `createRoot` í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ëŠ” ìˆœê°„ë¶€í„° ë¦¬ë Œë”ë§ì´ ë°œìƒí•  ë•Œê¹Œì§€ ë¦¬ì•¡íŠ¸ê°€ ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ”ì§€ë„ ì‚´í´ë³´ê³  ì‹¶ê³ , ìŠ¤ì¼€ì¤„ëŸ¬ë„ ë³€ê²½ ì‘ì—…ì„ ì „ë‹¬ë°›ì•„ì„œ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ì§€ì— ëŒ€í•´ì„œë„ ì•Œì•„ë³´ê³  ì‹¶ì§€ë§Œ ì°¨ê·¼ì°¨ê·¼ ê³µë¶€í•´ë³´ë ¤ê³  í•©ë‹ˆë‹¤. ì˜ëª» ì´í•´í•œ ì •ë³´ê°€ ìˆì„ ìˆ˜ë„ ìˆê³ , ë¦¬ì•¡íŠ¸ ì†ŒìŠ¤ì½”ë“œì— ëŒ€í•œ ì´í•´ë„ë¥¼ ë†’íˆë©´ì„œ ì ì°¨ ìˆ˜ì •í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

## References

ëª¨ë˜ ë¦¬ì•¡íŠ¸ ë”¥ë‹¤ì´ë¸Œ  
[React í†ºì•„ë³´ê¸° - 03. Hooks_1](https://goidle.github.io/react/in-depth-react-hooks_1/)  
[React íŒŒì´ë²„ ì•„í‚¤í…ì²˜ ë¶„ì„](https://d2.naver.com/helloworld/2690975)
